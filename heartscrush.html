<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hearts Crush</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram –∏ Supabase -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

    :root {
        /* –ë—ã–ª–æ 100px –∏ 3rem ‚Äî —ç—Ç–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ */
        /* –°—Ç–∞–≤–∏–º –∑–Ω–∞—á–µ–Ω–∏—è, –±–ª–∏–∑–∫–∏–µ –∫ —Ä–µ–∞–ª—å–Ω—ã–º –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ: */
        --reel-height: 60px; 
        --symbol-sz: 2rem;
    }
    
    body {
        font-family: 'Nunito', sans-serif;
        background: linear-gradient(135deg, #fdf2f8 0%, #fbcfe8 50%, #f9a8d4 100%);
        color: #831843;
        user-select: none;
        overflow-y: auto;
        min-height: 100vh;
        -webkit-tap-highlight-color: transparent;
    }

    /* –°—Ç–µ–∫–ª—è–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å */
    .glass-panel {
        background: rgba(255, 255, 255, 0.65); 
        border: 2px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 10px 30px rgba(236, 72, 153, 0.2);
        backdrop-filter: blur(12px);
        border-radius: 24px !important;
    }
    
    /* –§–æ–Ω –≤ —Ä–µ–∂–∏–º–µ –±–æ–Ω—É—Å–∞ */
    .bonus-mode-bg {
        background: linear-gradient(135deg, #be123c 0%, #e11d48 50%, #fb7185 100%) !important;
        border-color: #fecdd3 !important;
        box-shadow: 0 0 40px rgba(225, 29, 72, 0.6) !important;
    }
    .bonus-mode-bg .slot-window {
        box-shadow: inset 0 0 30px rgba(0,0,0,0.3);
    }

    .slot-window {
        overflow: hidden;
        position: relative;
        z-index: 10;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
    }

    .reel-col {
        width: 100%; height: 100%;
        display: flex; flex-direction: column; align-items: center;
        border-right: 1px solid rgba(236, 72, 153, 0.1);
        position: relative;
        justify-content: flex-start; 
    }
    .reel-col:last-child { border-right: none; }

    .slot-symbol {
        height: var(--reel-height);
        width: 100%;
        display: flex; 
        align-items: center; 
        justify-content: center;
        font-size: var(--symbol-sz);
        line-height: 1;
        /* filter: drop-shadow(0 2px 3px rgba(131, 24, 67, 0.2)); */
        flex-shrink: 0; 
        z-index: 1;
        will-change: transform;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .bonus-symbol-box {
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4), rgba(236, 72, 153, 0.4));
        border: 2px solid #ec4899;
        border-radius: 50%;
        width: 85%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 15px rgba(236, 72, 153, 0.6), inset 0 0 10px rgba(236, 72, 153, 0.3);
        animation: pulseBonus 1.5s infinite;
    }
    @keyframes pulseBonus {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 0 15px #db2777; }
        100% { transform: scale(1); }
    }

    .spin-btn {
        background: linear-gradient(180deg, #f472b6 0%, #db2777 100%);
        box-shadow: 0 6px 0 #9d174d, 0 5px 10px rgba(0,0,0,0.4);
        border-radius: 999px; 
        color: white; 
        border-top: 1px solid rgba(255,255,255,0.3);
        transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .spin-btn:active:not(:disabled) { 
        transform: translateY(6px); 
        box-shadow: 0 0 0 #9d174d; 
    }
    .spin-btn:disabled { 
        filter: grayscale(1) brightness(0.9);
        cursor: not-allowed; 
        transform: translateY(6px);
        box-shadow: 0 0 0 #9d174d;
    }
    
    
    .auto-btn {
        background: linear-gradient(180deg, #fff 0%, #fce7f3 100%);
        box-shadow: 0 6px 0 #fbcfe8, 0 5px 10px rgba(0,0,0,0.2); 
        border: 1px solid #fbcfe8; 
        border-radius: 20px; 
        color: #db2777;
        transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .auto-btn:active { 
        transform: translateY(6px); 
        box-shadow: 0 0 0 #fbcfe8; 
    }
    .auto-btn.active-auto { 
        background: linear-gradient(180deg, #86efac 0%, #22c55e 100%); 
        border-color: #14532d;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        transform: translateY(6px); 
        box-shadow: inset 0 3px 10px rgba(0,0,0,0.3); 
    }
    .auto-btn.active-auto:active { filter: brightness(0.9); }
    
    .modal-backdrop { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .control-btn {
        width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.5); border-radius: 50%; cursor: pointer; transition: all 0.2s;
        border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 2px 5px rgba(131, 24, 67, 0.1);
    }
    .control-btn:hover { background: #fff; transform: scale(1.1); }
    .control-btn:active { transform: scale(0.95); }

    .legend-card {
        background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(236, 72, 153, 0.2);
        border-radius: 12px; padding: 6px; display: flex; align-items: center; gap: 8px;
    }
    .legend-symbol { font-size: 1.8rem; width: 35px; display: flex; justify-content: center; }
    .payout-list { flex: 1; }
    .payout-row { display: flex; justify-content: space-between; font-size: 11px; font-weight: 800; }
    .balance-val { color: #be185d; font-weight: 900; }
    
    /* --- –ù–û–í–´–ô CSS –î–õ–Ø –°–ï–†–î–¶–ï–ë–ò–ï–ù–ò–Ø --- */
    @keyframes heartBeatAnim {
        0% { transform: scale(1); }
        15% { transform: scale(1.35); } /* –¢—É–∫ */
        30% { transform: scale(1); }
        45% { transform: scale(1.35); } /* –¢—É–∫ */
        60% { transform: scale(1); }
        100% { transform: scale(1); }
    }
    
    .symbol-heartbeat {
        z-index: 50 !important;
    }
    
    /* –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫ –∫—Ä—É–≥–ª–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –≤–Ω—É—Ç—Ä–∏ —Å–∏–º–≤–æ–ª–∞ */
    .symbol-heartbeat .bonus-symbol-box {
        animation: heartBeatAnim 0.7s ease-in-out forwards !important;
        box-shadow: 0 0 25px #be185d, inset 0 0 15px #db2777 !important;
        background: radial-gradient(circle at 30% 30%, #fff, #fbcfe8);
        border-color: #be185d;
    }

    @keyframes heartPopDeath {
        0% { transform: scale(1); filter: brightness(1); }
        
        /* –ü–ï–†–í–´–ô –£–î–ê–† (0.1—Å - 0.2—Å) - –ü—Ä–æ—Å—Ç–æ –ø—É–ª—å—Å */
        20% { transform: scale(1.15);  filter: brightness(1.1);}
        35% { transform: scale(0.9);  filter: brightness(1);}

        /* –í–¢–û–†–û–ô –£–î–ê–† (0.35—Å) - –í–∑—Ä—ã–≤ –∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ */
        50% { transform: scale(1.3); opacity: 1; filter: brightness(1.1); }
        100% { transform: scale(0.5); opacity: 0; filter: brightness(2);}
    }

    .symbol-heart-pop {
            /* –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 0.5—Å –∏–¥–µ–∞–ª—å–Ω–æ –ª–æ–∂–∏—Ç—Å—è –Ω–∞ –¥–≤–æ–π–Ω–æ–π –∑–≤—É–∫ */
            animation: heartPopDeath 0.5s ease-out forwards !important;
            z-index: 50;
        }
    
            .mult-low { color: #db2777; } /* x1-x2 –†–æ–∑–æ–≤—ã–π */
    .mult-med { color: #ea580c; text-shadow: 0 0 5px rgba(234, 88, 12, 0.4); } /* x4-x8 –û—Ä–∞–Ω–∂–µ–≤—ã–π */
    .mult-high { color: #dc2626; text-shadow: 0 0 10px rgba(220, 38, 38, 0.6); font-size: 1.1em; } /* x16-x32 –ö—Ä–∞—Å–Ω—ã–π */
    .mult-max { 
        background: linear-gradient(to right, #9333ea, #db2777, #ea580c); 
        -webkit-background-clip: text; 
        color: transparent; 
        text-shadow: 0 0 15px rgba(147, 51, 234, 0.5);
        font-size: 1.3em;
    } /* x64+ –≠–ø–∏—á–µ—Å–∫–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —É–¥–∞—Ä–∞ */
    @keyframes winBoom {
        0% { transform: scale(1); }
        50% { transform: scale(1.5); color: #16a34a; } /* –ó–µ–ª–µ–Ω—ã–π –≤—Å–ø–ª–µ—Å–∫ */
        100% { transform: scale(1); }
    }
    .win-boom { animation: winBoom 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

</style>
</head>
<body class="w-full min-h-screen flex flex-col items-center py-2">

    <div class="relative z-10 w-full max-w-2xl flex flex-col items-center gap-2 px-2">
        <div class="w-full flex justify-between items-center px-2 pt-2 pb-1">
            <!-- –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î –í –ú–ï–ù–Æ -->
            <button class="control-btn group" onclick="goHome()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-5 h-5 text-pink-500 group-hover:text-pink-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
            </button>
            <div class="text-center">
                <h1 class="text-3xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-red-500 to-purple-500 drop-shadow-sm tracking-tighter leading-none filter">
                    Hearts Crush
                </h1>
            </div>
            <div class="flex items-center gap-2">
                <button class="control-btn" onclick="game.togglePaytable()"><span class="text-xl font-bold text-pink-500">i</span></button>
                <button class="control-btn" onclick="game.toggleSound()"><span id="sound-icon" class="text-sm">üîä</span></button>
            </div>
        </div>

        <div class="w-full grid grid-cols-2 gap-3 px-1">
            <div class="glass-panel px-4 py-2 flex flex-col items-center justify-center h-16">
                <div class="text-xs font-bold text-pink-700 uppercase opacity-70">–ë–∞–ª–∞–Ω—Å</div>
                <!-- ID –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
                <div class="text-2xl balance-val transition-all duration-300" id="ui-balance">...</div>
            </div>
            <div class="glass-panel px-4 py-2 flex flex-col items-center justify-center h-16 w-full">
                <div class="text-xs font-bold text-pink-700 uppercase opacity-70">–í—ã–∏–≥—Ä—ã—à</div>
                <!-- –°—é–¥–∞ –±—É–¥–µ–º –ø–∏—Å–∞—Ç—å: 100 √ó4 -->
                <div class="text-2xl font-black text-slate-800 transition-all duration-200" id="ui-win">0</div>
            </div>
        </div>

        <div class="glass-panel p-2 md:p-4 w-full relative transition-colors duration-500" id="game-wrapper">
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ñ—Ä–∏—Å–ø–∏–Ω–æ–≤ (–°–≤–µ—Ä–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <div id="fs-badge" class="w-full mb-0 h-0 opacity-0 overflow-hidden transition-all duration-700 ease-in-out">
                <div class="w-full h-full mb-3 rounded-xl bg-gradient-to-r from-rose-600 via-pink-600 to-rose-600 text-white shadow-[0_4px_15px_rgba(225,29,72,0.4)] border border-pink-400/50 p-2 flex items-center justify-between px-4">
                    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å -->
                    <div class="flex flex-col items-start leading-tight">
                        <span class="text-[10px] font-bold uppercase text-pink-100 tracking-wider">–û—Å—Ç–∞–ª–æ—Å—å</span>
                        <div class="text-2xl font-black drop-shadow-md" id="fs-count">0</div>
                    </div>
                    <!-- –¶–µ–Ω—Ç—Ä -->
                    <div class="text-3xl animate-pulse filter drop-shadow-md">üíù</div>
                    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å -->
                    <div class="flex flex-col items-end leading-tight">
                        <span class="text-[10px] font-bold uppercase text-yellow-100 tracking-wider">–í—ã–∏–≥—Ä—ã—à</span>
                        <div class="text-2xl font-black text-yellow-300 drop-shadow-md" id="fs-total-win">0</div>
                    </div>
                </div>
            </div>

            <div class="bg-white/80 rounded-[20px] border-4 border-pink-200 shadow-inner relative overflow-hidden mb-3 aspect-[15/8] w-full h-auto">
                <div class="grid grid-cols-6 h-full w-full relative slot-window" id="slot-machine"></div>
            </div>

            <div class="w-full px-2 mb-3 flex justify-between items-center">
                <span id="status-text" class="text-sm font-bold text-pink-500 uppercase tracking-wide">–£–¥–∞—á–∏!</span>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-pink-400 font-bold uppercase">–°—Ç–∞–≤–∫–∞</span>
                    <span id="ui-total-bet" class="text-2xl font-black text-pink-800">20</span>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-center mb-2">
                    <div class="bg-white/50 rounded-2xl p-2 border border-pink-100 flex items-center gap-4">
                        <button class="bet-ctrl w-10 h-10 rounded-xl bg-pink-100 hover:bg-pink-200 text-pink-600 font-bold text-xl active:scale-95 transition disabled:opacity-50" onclick="game.adjustBet(-1)">-</button>
                        <div class="text-center w-20">
                            <div class="text-[9px] text-pink-400 uppercase font-bold">–°—Ç–∞–≤–∫–∞</div>
                            <div class="font-bold text-pink-800 text-lg leading-none" id="ui-bet">20</div>
                        </div>
                        <button class="bet-ctrl w-10 h-10 rounded-xl bg-pink-100 hover:bg-pink-200 text-pink-600 font-bold text-xl active:scale-95 transition disabled:opacity-50" onclick="game.adjustBet(1)">+</button>
                    </div>
                </div>
                <div class="flex gap-3 h-16 pb-1">
                    <button id="btn-auto" onclick="game.toggleAuto()" class="w-24 auto-btn text-xs font-bold flex flex-col items-center justify-center group">
                        <span class="text-xl mb-1 group-hover:scale-110 transition">üîÑ</span> AUTO
                    </button>
                    <button id="btn-spin" onclick="game.spin()" class="flex-1 spin-btn text-2xl font-black tracking-widest relative overflow-hidden group">
                        <span class="relative z-10 drop-shadow-md">SPIN</span>
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-500"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="paytable-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center modal-backdrop bg-pink-900/60 backdrop-blur-sm" onclick="game.togglePaytable()">
        <div class="glass-panel p-5 w-full max-w-lg m-4 relative max-h-[90vh] overflow-y-auto bg-white" onclick="event.stopPropagation()">
            <button class="absolute top-3 right-3 text-pink-400 hover:text-pink-600 text-xl font-bold" onclick="game.togglePaytable()">‚úï</button>
            <h2 class="text-center text-xl font-black text-pink-600 mb-4 uppercase">–í—ã–ø–ª–∞—Ç—ã</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="legend-grid-modal"></div>
            <div class="mt-4 p-3 bg-pink-50 rounded-lg border border-pink-100 text-center text-xs text-pink-800 font-bold">
                üéÅ 3+ –°–∏–º–≤–æ–ª–∞ = 20 –ë–ï–°–ü–õ–ê–¢–ù–´–• –°–ü–ò–ù–û–í
            </div>
        </div>
    </div>

    <!-- BONUS MODAL -->
    <div id="bonus-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center transition-all duration-700 opacity-0">
        <!-- –§–æ–Ω -->
        <div class="absolute inset-0 bg-rose-950/70 backdrop-blur-md transition-opacity duration-700"></div>
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
        <div id="bonus-card" class="relative w-[85%] max-w-sm bg-white/90 rounded-[2.5rem] p-6 text-center shadow-[0_0_50px_rgba(255,255,255,0.5)] border border-white/60 transform scale-90 translate-y-10 transition-all duration-500 ease-out flex flex-col items-center overflow-hidden">
            
            <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="absolute inset-0 bg-gradient-to-b from-pink-100/50 via-white/50 to-pink-200/50"></div>
            <div class="absolute top-0 left-0 w-full h-full opacity-30 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJub25lIiBzdHJva2U9IiNlYzQ4OTkiIHN0cm9rZS13aWR0aD0iMC41Ij48cGF0aCBkPSJNMTAgNi41Yy0xLjUtMi00LTItNC41IDAuNS0uNSAyLjUtLjUgNC41IDUuNSA1LjUgNi0xIDYtMyA1LjUtNS41LTEuNS0yLjUtLjUtNC41IDQuNVoiLz48L3N2Zz4=')]"></div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="relative z-10 flex flex-col items-center gap-3">
                <div class="text-6xl animate-[bounce_2s_infinite]">üíò</div>
                
                <h2 class="text-2xl font-black text-rose-600 uppercase tracking-tight leading-none">
                    –ú–∞–≥–∏—è –õ—é–±–≤–∏
                </h2>
                
                <p class="text-sm font-bold text-pink-400 uppercase tracking-widest border-b-2 border-pink-200 pb-2 mb-1">
                    –ë–æ–Ω—É—Å–Ω—ã–π —Ä–µ–∂–∏–º
                </p>
                
                <p class="text-gray-700 font-semibold text-base leading-snug px-2">
                    –ò —Å–µ—Ä–¥—Ü–∞ –∑–∞–±–∏–ª–∏—Å—å –≤ —É–Ω–∏—Å–æ–Ω...<br>
                    –ò —É–¥–∞—á–∞ —É–ª—ã–±–Ω–µ—Ç—Å—è –≤ —Ç–∞–Ω—Ü–µ...
                </p>

                <div class="py-2">
                    <span class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-rose-500 to-purple-600 drop-shadow-sm">
                        +10 FREE SPINS
                    </span>
                </div>

                <button onclick="game.closeBonusModalAndStart()" class="w-full py-3.5 rounded-2xl bg-gradient-to-r from-rose-500 to-pink-600 text-white font-black text-lg shadow-lg shadow-pink-500/40 hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span>–ó–ê–ü–£–°–¢–ò–¢–¨</span> ‚ù§Ô∏è
                </button>
            </div>
        </div>
    </div>

    <script>
            // === –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø SUPABASE ===
            const SUPABASE_URL = 'https://ugkactbowbcxkwnovkwe.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_myr7kO9VcTIIuwVwRKWIAg_8Ee_-5Ga'; // –¢–≤–æ–∏ –∫–ª—é—á–∏
            const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const tg = window.Telegram.WebApp;
            
            tg.expand();
            
            const USER_ID = tg.initDataUnsafe?.user?.id?.toString() || null;
            // –ö–ª—é—á —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –≤ –≥–ª–∞–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
            const LOCAL_STORAGE_KEY = 'jigu_bal_xl'; 

            // === –§–£–ù–ö–¶–ò–Ø –í–û–ó–í–†–ê–¢–ê ===
            function goHome() {
                // –ï—Å–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏, –ø—Ä–æ—Å—Ç–æ index.html
                // –ï—Å–ª–∏ —Ö–æ—Å—Ç–∏—à—å –≤ Vercel/GitHub Pages, —É–±–µ–¥–∏—Å—å, —á—Ç–æ –ø—É—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
                window.location.href = 'index.html'; 
            }

            // === GAME ASSETS ===
            const ASSETS = [
                // id 9 - –ø—É—Å—Ç–æ—Ç–∞
                { id: 9, val: '2', payout: 0, weight: 0 },   
                // id 8 - —Å–∫–∞—Ç—Ç–µ—Ä (—Å–µ—Ä–¥—Ü–µ-–±–æ–Ω—É—Å)
                { id: 8, val: '‚ù§Ô∏è', payout: 0, weight: 5 }, 
                
                // –î–æ—Ä–æ–≥–∏–µ —Å–∏–º–≤–æ–ª—ã
                { id: 7, val: 'üíç', payout: 9, weight: 20 },  
                { id: 6, val: 'üß∏', payout: 6, weight: 30 },  
                { id: 5, val: 'üåπ', payout: 3, weight: 40 },
                
                // –î–µ—à–µ–≤—ã–µ —Å–µ—Ä–¥—Ü–∞ (–ë–∞–∑–∞)
                { id: 4, val: 'üíö', payout: 1, weight: 50 }, 
                { id: 3, val: 'üíõ', payout: 1, weight: 50 },  
                { id: 2, val: 'üíú', payout: 1, weight: 50 },  
                { id: 1, val: 'üíô', payout: 1, weight: 50 },  
                { id: 0, val: 'üß°', payout: 1, weight: 50 }
            ];
            const BET_VALUES = [10, 20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000, 200000, 500000, 1000000, 10000000];
            
            const AudioSys = {
                ctx: new (window.AudioContext || window.webkitAudioContext)(),
                muted: localStorage.getItem('moji_sound') === 'false',
                
                check() {
                    if (this.muted) return false;
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    return true;
                },
                
                toggle() {
                    this.muted = !this.muted;
                    localStorage.setItem('moji_sound', !this.muted); return this.muted;
                },

                // === –í–û–¢ –≠–¢–û–ô –§–£–ù–ö–¶–ò–ò –ù–ï –•–í–ê–¢–ê–õ–û ===
                vibrate(type) {
                     // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ Telegram API, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫ –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ
                     if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                        window.Telegram.WebApp.HapticFeedback.impactOccurred(type);
                     }
                },

                playTone(f, t, d, v=0.1) {
                    if(!this.check()) return;
                    const o=this.ctx.createOscillator(), g=this.ctx.createGain();
                    o.type=t; o.frequency.value=f; g.gain.setValueAtTime(0, this.ctx.currentTime);
                    g.gain.linearRampToValueAtTime(v, this.ctx.currentTime+0.02);
                    g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime+d);
                    o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+d);
                },
                
                spin() { 
                    if (!this.check()) return;
                    this.playTone(196, 'sine', 0.15, 0.15); 
                    setTimeout(() => this.playTone(247, 'sine', 0.15, 0.15), 60); 
                    setTimeout(() => this.playTone(294, 'sine', 0.2, 0.15), 120); 
                },
                
                drop() { this.playTone(100, 'sine', 0.2, 0.1); },
                
                pop() { 
                    // 1. –í–∏–±—Ä–∞—Ü–∏—è (—Ç–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è vibrate —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
                    this.vibrate('medium');
                    setTimeout(() => this.vibrate('medium'), 150);

                    if(!this.check()) return;
                    
                    // –ó–≤—É–∫–æ–≤–∞—è —á–∞—Å—Ç—å (–≥–ª—É—Ö–æ–π —É–¥–∞—Ä)
                    const deepThud = (time, startFreq, volume) => {
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();
                        osc.connect(gain);
                        gain.connect(this.ctx.destination);
                        osc.type = 'sine'; 
                        osc.frequency.setValueAtTime(startFreq, time);
                        osc.frequency.exponentialRampToValueAtTime(startFreq * 0.6, time + 0.15);
                        gain.gain.setValueAtTime(0, time);
                        gain.gain.linearRampToValueAtTime(volume, time + 0.02);
                        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                        osc.start(time);
                        osc.stop(time + 0.25);
                    };

                    const now = this.ctx.currentTime;
                    deepThud(now, 70, 0.8);        
                    deepThud(now + 0.15, 90, 0.6); 
                },

                bonus() { [400,500,600].forEach((f,i)=>setTimeout(()=>this.playTone(f,'sine',0.4,0.5), i*100)); },
                
                heartbeat() { 
                    if(!this.check()) return;
                    this.playTone(100, 'sine', 0.15, 0.5); 
                    setTimeout(() => this.playTone(80, 'sine', 0.15, 0.4), 200);
                },
                
                win() { [400,500,600].forEach((f,i)=>setTimeout(()=>this.playTone(f,'sine',0.4,0.1), i*100)); },
                
                scatterDrop() { 
                    this.playTone(1200, 'sine', 0.3, 0.15); 
                    setTimeout(() => this.playTone(1800, 'sine', 0.4, 0.1), 50);
                }
            };

            class Reel {
                constructor(el, index) {
                    this.el = el;
                    this.index = index;
                    this.currentSymbols = [];
                    this.spinTimer = null;
                    this.resolveSpin = null;
                    this.targetSymbols = null; // –•—Ä–∞–Ω–∏–º —Ç–æ, —á—Ç–æ –¥–æ–ª–∂–Ω–æ –≤—ã–ø–∞—Å—Ç—å
                }
                
                get SYMBOL_HEIGHT() { return parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--reel-height'));  }

                generateRandomSet(count, isBonusMode = false, biasList = []) {
                    let tempAssets = ASSETS.map(a => {
                        let w = a.weight;
                        if (a.id === 9 && !isBonusMode) w = 0;
                        else if (a.id !== 9 && biasList.includes(a.id)) w *= 2; 
                        return { ...a, tempWeight: w };
                    });

                    let arr = [];
                    for(let i=0; i<count; i++) {
                        let total = tempAssets.reduce((a,c) => a + c.tempWeight, 0);
                        let r = Math.random() * total;
                        let s = ASSETS[0];
                        for(let a of tempAssets) {
                            r -= a.tempWeight;
                            if(r <= 0) { s = a; break; }
                        }
                        arr.push({...s, uid: Math.random().toString(36).substr(2, 9)});
                    }
                    return arr;
                }

                render(symbols, dropData = null) {
                    this.currentSymbols = symbols;
                    this.el.innerHTML = '';
                    symbols.forEach((s, idx) => {
                        const div = document.createElement('div');
                        div.className = 'slot-symbol';
                        if(s.id === 8) div.innerHTML = `<div class="bonus-symbol-box">${s.val}</div>`;
                        else div.innerText = s.val;
                        
                        if (dropData && s.offsetY !== undefined) {
                            div.style.transition = 'none'; 
                            div.style.transform = `translateY(${s.offsetY * 100}%)`;
                        }
                        this.el.appendChild(div);
                    });

                    if (dropData) {
                        this.el.offsetHeight; 
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                Array.from(this.el.children).forEach((div) => {
                                    div.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)'; 
                                    div.style.transform = 'translateY(0)';
                                });
                            });
                        });
                    }
                }

                spin(finalSymbols, duration, isBonusMode) {
                    this.targetSymbols = finalSymbols; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–ª—å –¥–ª—è turboStop
                    
                    return new Promise(resolve => {
                        this.resolveSpin = resolve;
                        
                        const baseSpeed = 12; 
                        const extraPerReel = 4;
                        const fillerCount = baseSpeed + (this.index * extraPerReel);
                        
                        const filler = this.generateRandomSet(fillerCount, isBonusMode);
                        const fullStrip = [...finalSymbols, ...filler, ...this.currentSymbols];
                        
                        this.el.innerHTML = '';
                        fullStrip.forEach(s => {
                            const div = document.createElement('div');
                            div.className = 'slot-symbol';
                            if(s.id === 8) div.innerHTML = `<div class="bonus-symbol-box">${s.val}</div>`;
                            else div.innerText = s.val;
                            this.el.appendChild(div);
                        });

                        const moveCount = fullStrip.length - 4;
                        const h = this.SYMBOL_HEIGHT;
                        const startY = -(moveCount * h);

                        this.el.style.transition = 'none';
                        this.el.style.transform = `translateY(${startY}px)`;
                        this.el.offsetHeight; 

                        // –û–±—ã—á–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ
                        this.el.style.transition = `transform ${duration}ms cubic-bezier(0.45, 0.05, 0.55, 0.95)`;
                        this.el.style.transform = `translateY(0px)`;

                        this.spinTimer = setTimeout(() => {
                            this.finishSpin(finalSymbols);
                        }, duration);
                    });
                }

                finishSpin(finalSymbols) {
                    this.render(finalSymbols);
                    this.el.style.transition = 'none';
                    this.el.style.transform = 'none';
                    
                    const hasScatter = finalSymbols.some(s => s.id === 8);
                    if (hasScatter) AudioSys.scatterDrop();
                    else AudioSys.drop();

                    if(this.resolveSpin) {
                        this.resolveSpin(); 
                        this.resolveSpin = null;
                    }
                    this.spinTimer = null;
                }

                // === –ù–û–í–´–ô –ú–ï–¢–û–î –ü–õ–ê–í–ù–û–ì–û –°–¢–û–ü–ê ===
                turboStop(delayMs) {
                    if (this.spinTimer) {
                        clearTimeout(this.spinTimer); // –û—Ç–º–µ–Ω—è–µ–º –¥–æ–ª–≥–∏–π —Ç–∞–π–º–µ—Ä
                        this.spinTimer = null;

                        // –î–µ–ª–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Ä—ã–≤–∫–æ–º (–¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –ª–µ—Å–µ–Ω–∫–∏)
                        setTimeout(() => {
                            // 1. –ú–µ–Ω—è–µ–º CSS –Ω–∞ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—É—é –∞–Ω–∏–º–∞—Ü–∏—é (0.2s)
                            // "cubic-bezier(0.2, 0.8, 0.2, 1)" - —ç—Ç–æ —Ä–µ–∑–∫–∏–π "–≤–∂—É—Ö" —Å –º—è–≥–∫–∏–º –∫–æ–Ω—Ü–æ–º
                            this.el.style.transition = 'transform 0.03s cubic-bezier(0, 1, 0, 1)';
                            
                            // Transform –º–µ–Ω—è—Ç—å –Ω–µ –Ω–∞–¥–æ, –æ–Ω —É–∂–µ —Å—Ç–æ–∏—Ç –Ω–∞ translateY(0px) –≤ spin()
                            // –ë—Ä–∞—É–∑–µ—Ä –ø—Ä–æ—Å—Ç–æ —É—Å–∫–æ—Ä–∏—Ç –¥–≤–∏–∂–µ–Ω–∏–µ –∫ —ç—Ç–æ–π —Ç–æ—á–∫–µ.

                            // 2. –ß–µ—Ä–µ–∑ 0.2s (–≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏) –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—Å—ë –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ
                            setTimeout(() => {
                                // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ —É—Å–ø–µ–ª–∞, finishSpin –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç—Ä–∏—Å—É–µ—Ç —Ñ–∏–Ω–∞–ª
                                if(this.targetSymbols) this.finishSpin(this.targetSymbols);
                            }, 30); 
                            
                        }, delayMs);
                    }
                }
            }

            class SlotMachine {
                constructor() {
                    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
                    const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
                    this.balance = saved ? parseInt(saved) : 1000;
                    this.gamesPlayed = 0; 
                    this.bet = 20;
                    this.reels = [];
                    this.isSpinning = false;
                    this.auto = false;
                    this.freeSpins = 0; 
                    this.bonusTotalWin = 0; // <--- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ö–£
                    this.currentGrid = [];
                    this.stopLocked = false; // –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ —Å—Ç–æ–ø-—Ñ–ª–∞–≥ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞
                    
                    this.initDB();

                    // --- –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ---
                    // –°–Ω–∞—á–∞–ª–∞ –≤—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∞, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–∫–∞—á–∫–∞
                    this.updateLayout(); 

                    // 2. –°–æ–∑–¥–∞–µ–º –±–∞—Ä–∞–±–∞–Ω—ã (—Ç–µ–ø–µ—Ä—å –æ–Ω–∏ —Å—Ä–∞–∑—É –±—É–¥—É—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞)
                    const container = document.getElementById('slot-machine');
                    // –û—á–∏—Å—Ç–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ç–∞–º –±—ã–ª –º—É—Å–æ—Ä
                    container.innerHTML = ''; 
                    
                    for(let i=0; i<6; i++) {
                        const div = document.createElement('div');
                        div.className = 'reel-col';
                        container.appendChild(div);
                        const r = new Reel(div, i);
                        r.render(r.generateRandomSet(4));
                        this.reels.push(r);
                    }
                    
                    // 3. –û—Å—Ç–∞–ª—å–Ω–æ–µ UI
                    this.updateUI();
                    this.renderPaytable();
                    
                    // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏–π –æ—Å—Ç–∞–≤–ª—è–µ–º
                    window.addEventListener('resize', () => this.updateLayout());
                }

                // === –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° –ë–ê–ó–û–ô ===
                async initDB() {
                    if (!USER_ID) return;
                    
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
                    const { data, error } = await sb
                        .from('players')
                        .select('balance, games_played')
                        .eq('tg_id', USER_ID)
                        .single();

                    if (data && !error) {
                        this.balance = data.balance;
                        this.gamesPlayed = data.games_played || 0;
                        localStorage.setItem(LOCAL_STORAGE_KEY, this.balance);
                        this.updateUI();
                    }
                }

                async saveBalanceToDB(newBalance, incrementGame = false) {
                    if (!USER_ID) return;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É
                    localStorage.setItem(LOCAL_STORAGE_KEY, newBalance);
                    
                    let updateData = { balance: newBalance };
                    if (incrementGame) {
                        // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª —Å–ø–∏–Ω, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º games_played
                        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ª—É—á—à–µ –¥–µ–ª–∞—Ç—å RPC –≤—ã–∑–æ–≤ increment, –Ω–æ —Ç–∞–∫ —Ç–æ–∂–µ —Å–æ–π–¥–µ—Ç –¥–ª—è MVP
                        // –ú—ã –±–µ—Ä–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π gamesPlayed –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
                        this.gamesPlayed++;
                        updateData.games_played = this.gamesPlayed;
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É "–≤ —Ñ–æ–Ω–µ" (–Ω–µ –∂–¥–µ–º await, —á—Ç–æ–±—ã –Ω–µ —Ñ—Ä–∏–∑–∏—Ç—å –∏–≥—Ä—É)
                    sb.from('players')
                      .update(updateData)
                      .eq('tg_id', USER_ID)
                      .then(({error}) => { if(error) console.error(error); });
                }
                // ==============================

                updateLayout() {
                    const w = document.getElementById('slot-machine').clientWidth / 6;
                    document.documentElement.style.setProperty('--reel-height', `${w * 0.8}px`);
                    document.documentElement.style.setProperty('--symbol-sz', `${w * 0.55}px`);
                }

                showBonusPanel() {
                    const badge = document.getElementById('fs-badge');
                    badge.classList.remove('h-0', 'opacity-0', 'mb-0');
                    badge.classList.add('h-20', 'opacity-100', 'mb-3'); // h-20 = 5rem (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
                }

                hideBonusPanel() {
                    const badge = document.getElementById('fs-badge');
                    badge.classList.remove('h-20', 'opacity-100', 'mb-3');
                    badge.classList.add('h-0', 'opacity-0', 'mb-0');
                }

                showBonusModal() {
                    return new Promise((resolve) => {
                        this.bonusPromiseResolve = resolve;
                        const modal = document.getElementById('bonus-modal');
                        const card = document.getElementById('bonus-card');
                        
                        modal.classList.remove('hidden');
                        // –ú–∞–ª–µ–Ω—å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ CSS –∞–Ω–∏–º–∞—Ü–∏–∏
                        setTimeout(() => {
                            modal.classList.remove('opacity-0');
                            card.classList.remove('scale-90', 'translate-y-10');
                            card.classList.add('scale-100', 'translate-y-0');
                        }, 50);
                        
                        AudioSys.bonus();
                    });
                }


                closeBonusModalAndStart() {
                    if (this.bonusPromiseResolve) {
                        const modal = document.getElementById('bonus-modal');
                        const card = document.getElementById('bonus-card');
                        
                        // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
                        modal.classList.add('opacity-0');
                        card.classList.remove('scale-100', 'translate-y-0');
                        card.classList.add('scale-90', 'translate-y-10'); // –£–µ–∑–∂–∞–µ—Ç –≤–Ω–∏–∑

                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');

                        // === –ó–î–ï–°–¨ –û–¢–ö–†–´–í–ê–ï–ú –ü–ê–ù–ï–õ–¨ –ü–õ–ê–í–ù–û ===
                        // –ü–æ–∫–∞ –º–æ–¥–∞–ª–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç, –ø–∞–Ω–µ–ª—å —Å–≤–µ—Ä—Ö—É –≤—ã–µ–∑–∂–∞–µ—Ç
                        this.showBonusPanel();
                        document.getElementById('game-wrapper').classList.add('bonus-mode-bg');

                        setTimeout(() => {
                            modal.classList.add('hidden');
                            this.bonusPromiseResolve(); 
                            this.bonusPromiseResolve = null;
                        }, 500); // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ CSS (500ms)
                    }
                }

                async spin() {
                    if (this.isSpinning) { this.forceStop(); return; }
                    this.stopLocked = false; 
                    
                    if (this.freeSpins === 0 && this.balance < this.bet) {
                        this.auto = false; 
                        this.updateUI();
                        tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç! üíî");
                        return;
                    }
                    
                    this.isSpinning = true;
                    this.updateUI(); 
                    AudioSys.spin();

                    // –û–±—ä–µ–∫—Ç –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –∫–∞–∫–∏–µ —Å–∏–º–≤–æ–ª—ã —Å—ã–≥—Ä–∞–ª–∏ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ
                    let roundHistory = {}; 

                    let sessionWin = 0;
                    document.getElementById('ui-win').innerText = "0";

                    if (this.freeSpins > 0) {
                        this.freeSpins--;
                        document.getElementById('fs-count').innerText = this.freeSpins;
                        document.getElementById('status-text').innerText = this.freeSpins === 0 ? "–ü–û–°–õ–ï–î–ù–ò–ô –®–ê–ù–°!" : `–û–°–¢–ê–õ–û–°–¨ –°–ü–ò–ù–û–í: ${this.freeSpins}`;
                    } else {
                        this.balance -= this.bet;
                        this.saveBalanceToDB(this.balance, true); 
                        document.getElementById('status-text').innerText = "–ò–©–ï–ú –õ–Æ–ë–û–í–¨...";
                    }
                    document.getElementById('ui-balance').innerText = this.balance; 

                    // –í—Ä–∞—â–µ–Ω–∏–µ
                    this.currentGrid = this.reels.map(r => r.generateRandomSet(4));
                    const spinPromises = this.reels.map((r, i) => r.spin(this.currentGrid[i], 600 + (i*150))); 
                    await Promise.all(spinPromises);
                    await new Promise(r => setTimeout(r, 200)); 
                    this.stopLocked = true; 

                    // –ö–∞—Å–∫–∞–¥—ã (–ü–µ—Ä–µ–¥–∞–µ–º roundHistory)
                    await this.processCascades(0, roundHistory);

                    // === –ü–†–û–í–ï–†–ö–ê –ë–û–ù–£–°–ê ===
                    let scatterCoords = [];
                    this.currentGrid.forEach((col, c) => {
                        col.forEach((s, r) => {
                            if(s.id === 8) scatterCoords.push({c, r}); 
                        });
                    });
                    
                    let bonusTriggered = false;

                    if(scatterCoords.length >= 3) {
                    bonusTriggered = true;
                    const isRetrigger = document.getElementById('game-wrapper').classList.contains('bonus-mode-bg');

                    await new Promise(r => setTimeout(r, 400));
                    for (let coord of scatterCoords) {
                            const reelEl = this.reels[coord.c].el;
                            const symbolEl = reelEl.children[coord.r]; 
                            if (symbolEl) {
                                symbolEl.classList.add('symbol-heartbeat');
                                AudioSys.heartbeat();
                                await new Promise(r => setTimeout(r, 600));
                            }
                    }

                    if (!isRetrigger) {
                            this.bonusTotalWin = 0;
                            document.getElementById('fs-total-win').innerText = "0";
                            await this.showBonusModal();
                            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#ec4899', '#fff', '#be123c'], gravity: 0.8 });
                            document.getElementById('status-text').innerText = "–õ–Æ–ë–û–í–ù–´–ô –†–ï–ñ–ò–ú!";
                    } else {
                            AudioSys.bonus();
                            confetti({ particleCount: 100, spread: 60, origin: { y: 0.7 }, colors: ['#ffd700', '#ec4899'] });
                    }
                    
                    this.freeSpins += 10;
                    document.getElementById('fs-count').innerText = this.freeSpins;
                    await new Promise(r => setTimeout(r, 1000));
                    }

                    // === –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–ö–°–¢ –°–¢–ê–¢–£–°–ê ===
                    // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—ã–ø–∞–ª –±–æ–Ω—É—Å - —Ç–µ–∫—Å—Ç –Ω–µ —Ç—Ä–æ–≥–∞–µ–º (—Ç–∞–º –Ω–∞–ø–∏—Å–∞–Ω–æ –ø—Ä–æ –±–æ–Ω—É—Å)
                    // –ï—Å–ª–∏ –±–æ–Ω—É—Å–∞ –Ω–µ –±—ã–ª–æ - —Å–º–æ—Ç—Ä–∏–º –∏—Å—Ç–æ—Ä–∏—é –≤—ã–∏–≥—Ä—ã—à–µ–π
                    if (!bonusTriggered) {
                        const playedSymbols = Object.keys(roundHistory);
                        
                        if (playedSymbols.length > 0) {
                            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É: "üíõx8 üíçx12"
                            // –°–æ—Ä—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã —Å–∞–º—ã–µ —Ä–µ–¥–∫–∏–µ/–¥–æ—Ä–æ–≥–∏–µ –±—ã–ª–∏ –ø–µ—Ä–≤—ã–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ map
                            const summary = playedSymbols.map(sym => `${sym}√ó${roundHistory[sym]}`).join('  ');
                            document.getElementById('status-text').innerText = `${summary}`;
                            document.getElementById('status-text').classList.add('text-rose-600'); // –î–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç —è—Ä—á–µ
                        } else {
                            // –ï—Å–ª–∏ –ø—É—Å—Ç–æ
                            document.getElementById('status-text').innerText = "–£–î–ê–ß–ò!";
                            document.getElementById('status-text').classList.remove('text-rose-600');
                        }
                    }

                    // === –ó–ê–í–ï–†–®–ï–ù–ò–ï –ë–û–ù–£–°–ê ===
                    if(this.freeSpins === 0 && document.getElementById('game-wrapper').classList.contains('bonus-mode-bg')) {
                        await new Promise(r => setTimeout(r, 500));
                        document.getElementById('game-wrapper').classList.remove('bonus-mode-bg');
                        this.hideBonusPanel();
                        
                        document.getElementById('status-text').innerText = `–ò–¢–û–ì –ë–û–ù–£–°–ê: ${this.bonusTotalWin}`;
                        if(this.bonusTotalWin > 0) confetti({ particleCount: 100, spread: 100, origin: { y: 0.6 } });
                    } 
                    
                    this.isSpinning = false;
                    this.updateUI(); 
                    
                    if (this.auto || (this.freeSpins > 0)) {
                        setTimeout(() => this.spin(), 600); 
                    }
                }

                getMultClass(m) {
                    if (m >= 64) return 'mult-max';
                    if (m >= 16) return 'mult-high';
                    if (m >= 4) return 'mult-med';
                    return 'mult-low';
                }

                async processCascades(sessionWin, roundHistory = {}) {
                    let safety = 0;
                    let rawSessionWin = 0;
                    let currentMult = 1;
                    let cascadeCount = 0; // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä—ã–≤–æ–≤

                    const uiWinEl = document.getElementById('ui-win');

                    while(safety++ < 20) {
                        // 1. –°—á–∏—Ç–∞–µ–º –≤—ã–∏–≥—Ä—ã—à –Ω–∞ —Ç–µ–∫—É—â–µ–º –ø–æ–ª–µ
                        const { winAmount, winCoords, winDetails } = this.calculateWins(this.currentGrid);
                        
                        // –ï—Å–ª–∏ –≤—ã–∏–≥—Ä—ã—à–µ–π –Ω–µ—Ç - –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª –∫–∞—Å–∫–∞–¥–æ–≤
                        if (winAmount === 0) break;

                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–∞—Å–∫–∞–¥–æ–≤, —Ç–∞–∫ –∫–∞–∫ –≤–∑—Ä—ã–≤ –µ—Å—Ç—å
                        cascadeCount++;

                        // 2. –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º "—Å—ã—Ä–æ–π" –≤—ã–∏–≥—Ä—ã—à
                        rawSessionWin += winAmount;

                        // 3. –û–±–Ω–æ–≤–ª—è–µ–º –ú–ù–û–ñ–ò–¢–ï–õ–¨ –ü–û –ù–û–í–û–ô –õ–û–ì–ò–ö–ï
                        // 1-–π –≤–∑—Ä—ã–≤: x1 (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
                        // 2-–π –≤–∑—Ä—ã–≤: x2
                        // 3-–π –≤–∑—Ä—ã–≤: x4 (–¥–∞–ª–µ–µ —É–¥–≤–∞–∏–≤–∞–µ–º)
                        if (cascadeCount === 1) {
                            currentMult = 1;
                        } else if (cascadeCount === 2) {
                            currentMult = 2;
                        } else {
                            currentMult *= 2;
                            if(currentMult > 128) currentMult = 128; // –õ–∏–º–∏—Ç
                        }

                        // 4. –û–±–Ω–æ–≤–ª—è–µ–º UI
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "xN" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–Ω–æ–∂–∏—Ç–µ–ª—å –±–æ–ª—å—à–µ 1 (–Ω–∞—á–∏–Ω–∞—è —Å–æ 2-–≥–æ –≤–∑—Ä—ã–≤–∞)
                        const multHtml = currentMult > 1 
                            ? ` <span class="${this.getMultClass(currentMult)}">√ó${currentMult}</span>` 
                            : '';
                        
                        uiWinEl.innerHTML = `${rawSessionWin}${multHtml}`;
                        
                        // –≠—Ñ—Ñ–µ–∫—Ç —É–¥–∞—Ä–∞ –ø–æ —Ç–µ–∫—Å—Ç—É
                        uiWinEl.style.transform = "scale(1.2)";
                        setTimeout(() => uiWinEl.style.transform = "scale(1)", 150);

                        // 5. –õ–æ–≥–∏ –∏ —Å—Ç–∞—Ç—É—Å –±–∞—Ä
                        if (winDetails) {
                            winDetails.forEach(d => {
                                if (!roundHistory[d.symbol]) roundHistory[d.symbol] = 0;
                                roundHistory[d.symbol] += d.count;
                            });
                            const summary = Object.keys(roundHistory).map(sym => `${sym}`).join(' ');
                            // –ï—Å–ª–∏ –º–Ω–æ–∂–∏—Ç–µ–ª—å 1, –Ω–µ –ø–∏—à–µ–º "–ö–û–ú–ë–û x1", –ø–∏—à–µ–º –ø—Ä–æ—Å—Ç–æ —Å–∏–º–≤–æ–ª—ã
                            const comboText = currentMult > 1 ? ` | –ö–û–ú–ë–û √ó${currentMult}` : '';
                            document.getElementById('status-text').innerText = `${summary}${comboText}`;
                        }

                        // 6. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–∑—Ä—ã–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤
                        winCoords.forEach(c => {
                            const node = this.reels[c.c].el.children[c.r];
                            if(node) node.classList.add('symbol-heart-pop');
                        });
                        AudioSys.pop(); 
                        
                        // –ñ–¥–µ–º –ø–æ–∫–∞ –∞–Ω–∏–º–∞—Ü–∏—è –≤–∑—Ä—ã–≤–∞ –ø—Ä–æ–π–¥–µ—Ç
                        await new Promise(r => setTimeout(r, 500));
                        
                        // 7. –ü–∞–¥–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ (–ú–µ—Ö–∞–Ω–∏–∫–∞ –∫–∞—Å–∫–∞–¥–∞)
                        let allSurvivorIds = [];
                        this.currentGrid.forEach((col, colIdx) => {
                            col.forEach((s, rowIdx) => {
                                const isExploding = winCoords.some(w => w.c === colIdx && w.r === rowIdx);
                                if (!isExploding) { allSurvivorIds.push(s.id); }
                            });
                        });

                        for(let c=0; c<6; c++) {
                            const colBadIndices = winCoords.filter(w => w.c === c).map(w => w.r);
                            if(colBadIndices.length === 0) continue;

                            const oldCol = this.currentGrid[c];
                            let survivors = [];
                            oldCol.forEach((s, rIndex) => {
                                if (!colBadIndices.includes(rIndex)) { survivors.push({ ...s, oldRow: rIndex }); }
                            });

                            const needed = 4 - survivors.length;
                            const newSyms = this.reels[c].generateRandomSet(needed, false, allSurvivorIds);
                            newSyms.forEach((s, i) => { s.oldRow = i - needed; s.isNew = true; });

                            const newColState = [...newSyms, ...survivors];
                            newColState.forEach((s, newIndex) => {
                                const diff = s.oldRow - newIndex;
                                s.offsetY = diff; 
                            });

                            this.currentGrid[c] = newColState;
                            this.reels[c].render(newColState, true);
                        }

                        AudioSys.drop();
                        await new Promise(r => setTimeout(r, 450)); 
                    }

                    // === –§–ò–ù–ê–õ: –ó–ê–ß–ò–°–õ–ï–ù–ò–ï –î–ï–ù–ï–ì ===
                    if (rawSessionWin > 0) {
                        // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ü–ê–£–ó–´:
                        // –ï—Å–ª–∏ –≤–∑—Ä—ã–≤–æ–≤ –±—ã–ª–æ > 1 (—Å—Ä–∞–±–æ—Ç–∞–ª –º–Ω–æ–∂–∏—Ç–µ–ª—å), –¥–µ–ª–∞–µ–º –ø–∞—É–∑—É –¥–ª—è –æ—Å–æ–∑–Ω–∞–Ω–∏—è
                        // –ï—Å–ª–∏ –≤–∑—Ä—ã–≤ –±—ã–ª 1 (x1), –¥–µ–Ω—å–≥–∏ –∑–∞—á–∏—Å–ª—è–µ–º —Å—Ä–∞–∑—É
                        if (cascadeCount > 1) {
                            await new Promise(r => setTimeout(r, 600));
                        }

                        const finalPayout = rawSessionWin * currentMult;

                        // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–±–µ–¥—ã
                        uiWinEl.innerHTML = `<span class="text-green-600 font-black">${finalPayout}</span>`;
                        uiWinEl.classList.add('win-boom');
                        AudioSys.win(); 

                        // –†–µ–∞–ª—å–Ω–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ
                        this.balance += finalPayout;
                        this.saveBalanceToDB(this.balance, false);
                        
                        if (document.getElementById('game-wrapper').classList.contains('bonus-mode-bg')) {
                            this.bonusTotalWin += finalPayout;
                            document.getElementById('fs-total-win').innerText = this.bonusTotalWin;
                        }

                        document.getElementById('ui-balance').innerText = this.balance;

                        // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ü–∏—Ñ—Ä
                        await new Promise(r => setTimeout(r, 500));
                        uiWinEl.classList.remove('win-boom');
                    }
                }

                calculateWins(grid) {
                    let counts = {};
                    let coords = {};
                    
                    // –°—á–∏—Ç–∞–µ–º —Å–∏–º–≤–æ–ª—ã
                    grid.forEach((col, c) => col.forEach((s, r) => {
                        if(s.id === 8 || s.id === 9) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫–∞—Ç—Ç–µ—Ä—ã –∏ –ø—É—Å—Ç—ã—à–∫–∏
                        if(!counts[s.id]) { counts[s.id]=0; coords[s.id]=[]; }
                        counts[s.id]++; coords[s.id].push({c,r});
                    }));
                    
                    let winAmount = 0;
                    let winCoords = [];
                    let winDetails = []; // <--- –ù–æ–≤—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π

                    for(let id in counts) {
                        // –£—Å–ª–æ–≤–∏–µ –≤—ã–∏–≥—Ä—ã—à–∞ (7+ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö)
                        if(counts[id] >= 7) { 
                            const asset = ASSETS.find(a=>a.id==id);
                            
                            let mul = 0.1; 
                            if(counts[id] >= 8) mul = 0.25;
                            if(counts[id] >= 10) mul = 0.5;
                            if(counts[id] >= 12) mul = 1;

                            let payout = Math.floor(this.bet * asset.payout * mul);
                            if (payout < 1 && asset.payout > 0) payout = 1; 

                            winAmount += payout;
                            winCoords.push(...coords[id]);
                            
                            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, –∫–∞–∫–æ–π —Å–∏–º–≤–æ–ª —Å—ã–≥—Ä–∞–ª –∏ —Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫
                            winDetails.push({ 
                                symbol: asset.val, 
                                count: counts[id] 
                            });
                        }
                    }
                    return { winAmount, winCoords, winDetails };
                }

                forceStop() {
                    if(this.stopLocked) return; 
                    this.stopLocked = true;
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç "Zipper": –±–∞—Ä–∞–±–∞–Ω—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –Ω–µ –≤—Å–µ —Å—Ä–∞–∑—É,
                    // –∞ —Å —à–∞–≥–æ–º –≤ 60–º—Å (0ms, 60ms, 120ms, 180ms...)
                    // –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –æ—â—É—â–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏, –Ω–æ —É–±–∏—Ä–∞–µ—Ç "–¥–µ—Ä–≥–∞–Ω–æ—Å—Ç—å".
                    this.reels.forEach((r, i) => {
                        r.turboStop(i * 30); 
                    });
                }

                updateUI() {
                    document.getElementById('ui-balance').innerText = this.balance;
                    document.getElementById('ui-bet').innerText = this.bet;
                    document.getElementById('ui-total-bet').innerText = this.bet;
                    
                    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ–Ω—å–≥–∏ –ò–õ–ò –µ—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç —Å–ø–∏–Ω (—á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å)
                    const canPressSpin = (this.balance >= this.bet || this.freeSpins > 0) || this.isSpinning;
                    document.getElementById('btn-spin').disabled = !canPressSpin;
                    
                    // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
                    const btnTextSpan = document.querySelector('#btn-spin span');
                    if(this.isSpinning) {
                        btnTextSpan.innerText = "STOP";
                        document.getElementById('btn-spin').classList.add('brightness-110'); // –ü–æ–¥—Å–≤–µ—Ç–∫–∞
                    } else {
                        btnTextSpan.innerText = "SPIN";
                        document.getElementById('btn-spin').classList.remove('brightness-110');
                    }
                    
                    if(this.auto) document.getElementById('btn-auto').classList.add('active-auto');
                    else document.getElementById('btn-auto').classList.remove('active-auto');

                    const canChangeBet = !this.isSpinning && this.freeSpins === 0 && !this.auto;
                    document.querySelectorAll('.bet-ctrl').forEach(btn => btn.disabled = !canChangeBet);
                }
                
                togglePaytable() { document.getElementById('paytable-modal').classList.toggle('hidden'); }
                renderPaytable() {
                    const d = document.getElementById('legend-grid-modal'); d.innerHTML='';
                    ASSETS.forEach(a=>{
                        if(a.id>7)return;
                        d.innerHTML+=`<div class="legend-card"><div class="legend-symbol">${a.val}</div><div class="payout-list"><div class="payout-row"><span>12+</span><span class="text-pink-600">${Math.floor(this.bet*a.payout)}</span></div></div></div>`;
                    });
                }
                adjustBet(d) {
                    if(this.isSpinning || this.freeSpins > 0 || this.auto) return;
                    let i = BET_VALUES.indexOf(this.bet)+d;
                    if(i>=0 && i<BET_VALUES.length) { 
                        this.bet=BET_VALUES[i]; 
                        this.updateUI(); 
                        this.renderPaytable(); 
                    }
                }
                toggleSound() { AudioSys.toggle(); document.getElementById('sound-icon').innerText = AudioSys.muted ? 'üîá':'üîä'; }
                toggleAuto() { 
                    this.auto=!this.auto; 
                    this.updateUI();
                    if(this.auto && !this.isSpinning) this.spin(); 
                }
            }

            window.game = new SlotMachine();
    </script>
</body>
</html>










