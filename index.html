<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moji Slots</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="profile.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–µ–π */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü */
        .page-view {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∏–≥—Ä—ã */
        .game-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        .game-card:active { transform: scale(0.96); }
        .game-card::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.8) 100%); z-index: 1;
        }
        .shiny-effect::before {
            content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-15deg); z-index: 10;
            animation: shine 3s infinite; pointer-events: none;
        }
        @keyframes shine { 0% { transform: translateX(-100%) skewX(-15deg); } 100% { transform: translateX(200%) skewX(-15deg); } }

        /* –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
        .bottom-nav-item {
            color: #64748b; transition: color 0.2s;
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        .bottom-nav-item.active-nav { color: #facc15; }

        /* –¢–æ–≥–≥–ª */
        .toggle-checkbox:checked { right: 0; border-color: #22c55e; }
        .toggle-checkbox:checked + .toggle-label { background-color: #22c55e; }
    </style>
</head>
<!-- –í–ê–ñ–ù–û: h-screen –≤–º–µ—Å—Ç–æ min-h-screen —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –≤—ã—Å–æ—Ç—É, –ø–æ–∑–≤–æ–ª—è—è —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è main -->
<body class="w-full h-screen bg-gradient-to-b from-[#1a0b2e] via-slate-900 to-slate-950 flex flex-col relative overflow-hidden">

    <!-- –§–û–ù -->
    <div class="fixed top-[-10%] left-[-10%] w-[50vw] h-[50vw] bg-purple-600/20 rounded-full blur-[80px] pointer-events-none transform-gpu"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[50vw] h-[50vw] bg-yellow-600/10 rounded-full blur-[80px] pointer-events-none transform-gpu"></div>

    <!-- HEADER (–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è) -->
    <header class="px-4 pt-4 pb-2 flex justify-between items-center z-20 shrink-0">
        <!-- Avatar & Name -->
        <div class="flex items-center gap-3 cursor-pointer group" onclick="navigate('profile')">
            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-yellow-400 to-orange-500 p-0.5 shadow-lg shadow-orange-500/20 group-active:scale-95 transition">
                <div class="w-full h-full rounded-full bg-slate-900 flex items-center justify-center text-xl overflow-hidden relative">
                   <img id="user-avatar" src="" alt="üë§" class="w-full h-full object-cover hidden">
                   <span id="user-avatar-fallback">üòé</span>
                </div>
            </div>
            <div class="leading-tight">
                <!-- –î–û–ë–ê–í–õ–ï–ù ID header-rank -->
                <div id="header-rank" class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">–ò–≥—Ä–æ–∫</div>
                <div id="username" class="font-bold text-white text-sm">Guest</div>
            </div>
        </div>
        
        <!-- Balance Row -->
        <div class="flex items-center gap-2">
            <button onclick="toggleWallet(true)" class="w-9 h-9 rounded-full bg-green-600 hover:bg-green-500 text-white font-bold text-xl flex items-center justify-center shadow-lg active:scale-95 transition">
                +
            </button>
            <div class="glass-panel px-3 py-1.5 rounded-full flex items-center gap-2 pr-4" onclick="toggleWallet(true)">
                <div class="w-6 h-6 rounded-full bg-yellow-500 flex items-center justify-center text-xs shadow-inner text-yellow-900 font-black">$</div>
                <span id="header-balance" class="font-mono font-bold text-yellow-400 text-lg tracking-tight">0</span>
            </div>
        </div>
    </header>

    <!-- CONTENT CONTAINER (–°–∫—Ä–æ–ª–ª–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —ç—Ç–æ) -->
    <main class="flex-1 overflow-y-auto z-10 scroll-smooth relative w-full no-scrollbar">

        <!-- ================= PAGE: HOME ================= -->
        <div id="view-home" class="page-view active px-4 py-2">
            
            <!-- Hero Banner -->
            <div class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-5 mb-6 shadow-2xl shadow-purple-500/20 relative overflow-hidden shrink-0">
                <div class="absolute right-[-20px] top-[-20px] text-[8rem] opacity-20 rotate-12">üé∞</div>
                <div class="relative z-10">
                    <h1 class="text-3xl font-black italic text-white mb-1">Moji <span class="text-yellow-400">Slots</span></h1>
                    <p class="text-indigo-100 text-xs font-medium max-w-[70%] mb-3">–¢–≤–æ—è —É–¥–∞—á–∞ —Å–µ–≥–æ–¥–Ω—è –∑–¥–µ—Å—å!</p>
                    <button onclick="toggleWallet(true)" class="bg-white text-indigo-700 px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider shadow-lg active:scale-95 transition">
                        –ú–æ–π –ö–æ—à–µ–ª–µ–∫
                    </button>
                </div>
            </div>

            <!-- Games Title -->
            <div class="flex items-center justify-between mb-3 px-1">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="text-yellow-500">üî•</span> –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ
                </h2>
                <span class="text-[10px] text-slate-500 font-bold">–í–°–ï –ò–ì–†–´</span>
            </div>

            <!-- Games List -->
            <div class="space-y-4">
                
                <!-- GAME 1: BOOMSHAKE -->
                <div onclick="openGame('boomshake.html')" class="game-card shiny-effect group w-full aspect-[1.79/1] rounded-2xl bg-slate-800 relative cursor-pointer border border-slate-700 hover:border-purple-500/50">
                    
                    <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ -->
                    <div class="absolute inset-0 bg-[url('img/boomshake.jpg')] bg-cover bg-center opacity-80 group-hover:opacity-100 transition group-hover:scale-105 duration-700"></div>
                    
                    <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–ª—Å—è –Ω–∞ –ª—é–±–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ -->
                    <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/90 to-transparent pointer-events-none"></div>

                    <div class="absolute bottom-0 left-0 w-full p-4 z-20 flex justify-between items-end">
                        <div>
                            <span class="px-1.5 py-0.5 rounded bg-red-600 text-[8px] font-black text-white uppercase shadow mb-1 inline-block">HOT</span>
                            <h3 class="text-2xl font-black text-white drop-shadow-md leading-none">BoomShake</h3>
                            <p class="text-[10px] text-slate-300 font-bold mt-1">–°–æ—á–Ω–æ. –ú–æ—â–Ω–æ. –í–∑—Ä—ã–≤–æ–æ–ø–∞—Å–Ω–æ.</p>
                        </div>
                        <button class="w-12 h-12 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center text-2xl shadow-[0_0_15px_rgba(250,204,21,0.6)] hover:scale-110 transition">‚ñ∂</button>
                    </div>
                </div>

                <div onclick="openGame('heartscrush.html')" class="game-card shiny-effect group w-full aspect-[1.79/1] rounded-2xl bg-pink-900 relative cursor-pointer border border-pink-700 hover:border-purple-500/50">
                    
                    <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ -->
                    <div class="absolute inset-0 bg-[url('img/heartscrush.png')] bg-cover bg-center opacity-80 group-hover:opacity-100 transition group-hover:scale-105 duration-700"></div>
                    
                    <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–ª—Å—è –Ω–∞ –ª—é–±–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ -->
                    <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/90 to-transparent pointer-events-none"></div>

                    <div class="absolute bottom-0 left-0 w-full p-4 z-20 flex justify-between items-end">
                        <div>
                            <span class="px-2 py-0.5 rounded bg-pink-500 text-[9px] font-black text-white uppercase shadow-lg mb-1 inline-block">NEW</span>
                            <h3 class="text-2xl font-black text-white drop-shadow-md leading-none">Hearts Crush</h3>
                            <p class="text-[10px] text-slate-300 font-bold mt-1">–õ—é–±–æ–≤—å —Ç–∞–∫–∞—è –ª—é–±–æ–≤—å...</p>
                        </div>
                        <button class="w-12 h-12 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center text-2xl shadow-[0_0_15px_rgba(250,204,21,0.6)] hover:scale-110 transition">‚ñ∂</button>
                    </div>
                </div>

                <!-- Grid of games -->
                <div class="grid grid-cols-2 gap-3">
                    <!-- Stub 1 -->
    
                    <!-- –ù–û–í–ê–Ø –ò–ì–†–ê: RED VS BLACK -->
                    <div onclick="openGame('redvsblack.html')" class="game-card shiny-effect w-full aspect-square rounded-2xl bg-slate-800 relative cursor-pointer border border-slate-700 hover:border-red-500/50 group overflow-hidden">
                        
                        <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–∞ —Ñ–æ–Ω–µ (—Å –∑—É–º–æ–º –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏) -->
                        <div class="absolute inset-0 bg-[url('img/redvsblack.png')] bg-cover bg-center transition duration-700 group-hover:scale-110"></div>
                        
                        <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–ª—Å—è -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                        
                        <!-- –¢–µ–∫—Å—Ç –∏ –ª–µ–π–±–ª -->
                        <div class="absolute bottom-0 left-0 w-full p-3 z-20">
                            <span class="px-1.5 py-0.5 rounded bg-red-600 text-[8px] font-black text-white uppercase shadow mb-1 inline-block">NEW</span>
                            <h3 class="text-sm font-black text-white leading-tight">Red vs Black</h3>
                            <p class="text-[9px] text-slate-300 font-bold">–ö—Ä–∞—Å–Ω–æ–µ –∏–ª–∏ –ß–µ—Ä–Ω–æ–µ?</p>
                        </div>

                        <!-- –ë–ª–∏–∫ (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã) -->
                        <div class="absolute top-0 right-0 w-full h-full bg-gradient-to-bl from-white/10 to-transparent pointer-events-none"></div>
                    </div>

                    
                    <!-- Stub 2 -->
                    <!-- GAME: LUXURY POO -->
                    <div onclick="openGame('luxurypoo.html')" class="game-card shiny-effect group w-full aspect-square rounded-2xl bg-[#271005] relative cursor-pointer border border-amber-900 hover:border-amber-500 overflow-hidden">
                        

                       <div class="absolute inset-0 bg-[url('img/luxurypoo.png')] bg-cover bg-center transition duration-700 group-hover:scale-110"></div>
                       
                        
                        <!-- –¢–µ–∫—Å—Ç —Å–Ω–∏–∑—É -->
                        <div class="absolute bottom-0 left-0 w-full p-3 z-20 bg-gradient-to-t from-black/90 to-transparent">
                            <span class="px-1.5 py-0.5 rounded bg-amber-500 text-[8px] font-black text-black uppercase shadow mb-1 inline-block">ROYAL</span>
                            <h3 class="text-sm font-black text-amber-100 leading-tight">Luxury Poo</h3>
                            <p class="text-[9px] text-amber-400/70 font-bold">–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π —Ç—Ä–æ–Ω, –Ω–æ –æ—á–µ–Ω—å –æ–ø–∞—Å–Ω—ã–π!</p>
                        </div>
                    </div>
                    
                    <!-- Stub 3 (Extra for scroll test) -->
                    <div onclick="tg.showAlert('–°–∫–æ—Ä–æ!')" class="game-card w-full aspect-square rounded-2xl bg-slate-800 relative cursor-pointer border border-slate-700 opacity-80 grayscale">
                        <div class="absolute inset-0 flex items-center justify-center text-6xl opacity-20">üöÄ</div>
                        <div class="absolute bottom-0 left-0 w-full p-3 z-20">
                            <h3 class="text-sm font-black text-white">Crash</h3>
                            <p class="text-[9px] text-slate-400 font-bold">–°–∫–æ—Ä–æ...</p>
                        </div>
                        <div class="absolute top-2 right-2 text-xl">üîí</div>
                    </div>
                    <!-- Stub 4 (Extra for scroll test) -->
                    <div onclick="tg.showAlert('–°–∫–æ—Ä–æ!')" class="game-card w-full aspect-square rounded-2xl bg-slate-800 relative cursor-pointer border border-slate-700 opacity-80 grayscale">
                        <div class="absolute inset-0 flex items-center justify-center text-6xl opacity-20">üé≤</div>
                        <div class="absolute bottom-0 left-0 w-full p-3 z-20">
                            <h3 class="text-sm font-black text-white">Dice</h3>
                            <p class="text-[9px] text-slate-400 font-bold">–°–∫–æ—Ä–æ...</p>
                        </div>
                        <div class="absolute top-2 right-2 text-xl">üîí</div>
                    </div>
                     <!-- Stub 5 (Extra for scroll test) -->
                     <div onclick="tg.showAlert('–°–∫–æ—Ä–æ!')" class="game-card w-full aspect-square rounded-2xl bg-slate-800 relative cursor-pointer border border-slate-700 opacity-80 grayscale">
                        <div class="absolute inset-0 flex items-center justify-center text-6xl opacity-20">üé±</div>
                        <div class="absolute bottom-0 left-0 w-full p-3 z-20">
                            <h3 class="text-sm font-black text-white">Keno</h3>
                            <p class="text-[9px] text-slate-400 font-bold">–°–∫–æ—Ä–æ...</p>
                        </div>
                        <div class="absolute top-2 right-2 text-xl">üîí</div>
                    </div>
                     <!-- Stub 6 (Extra for scroll test) -->
                     <div onclick="tg.showAlert('–°–∫–æ—Ä–æ!')" class="game-card w-full aspect-square rounded-2xl bg-slate-800 relative cursor-pointer border border-slate-700 opacity-80 grayscale">
                        <div class="absolute inset-0 flex items-center justify-center text-6xl opacity-20">üíé</div>
                        <div class="absolute bottom-0 left-0 w-full p-3 z-20">
                            <h3 class="text-sm font-black text-white">Mines</h3>
                            <p class="text-[9px] text-slate-400 font-bold">–°–∫–æ—Ä–æ...</p>
                        </div>
                        <div class="absolute top-2 right-2 text-xl">üîí</div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- ================= PAGE: PROFILE ================= -->
        <div id="view-profile" class="page-view px-4 py-6">
            <div class="flex flex-col items-center mb-8">
                <div class="w-24 h-24 rounded-full p-1 bg-gradient-to-tr from-yellow-400 to-purple-600 shadow-2xl mb-3 relative group" onclick="toggleEditModal(true)">
                        <img id="profile-avatar-big" src="" class="w-full h-full rounded-full bg-slate-900 object-cover border-4 border-slate-900">
                        <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div class="absolute bottom-0 right-0 bg-blue-600 border-2 border-slate-900 rounded-full w-8 h-8 flex items-center justify-center text-xs shadow-lg cursor-pointer active:scale-90 transition text-white">‚úèÔ∏è</div>
                </div>
                
                <!-- –ò–º—è —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ -->
                <div class="flex items-center gap-2 cursor-pointer" onclick="toggleEditModal(true)">
                    <h2 class="text-2xl font-black text-white" id="profile-name">Guest</h2>
                    <span class="text-slate-500 text-xs opacity-50">‚úé</span>
                </div>
                
                <span id="profile-rank-badge" class="px-3 py-1 mt-2 rounded-full text-[10px] font-bold border transition-all duration-300">
                    –ó–ê–ì–†–£–ó–ö–ê...
                </span>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="glass-panel p-4 rounded-2xl flex flex-col items-center">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">–ë–∞–ª–∞–Ω—Å</span>
                    <span class="text-xl font-mono font-bold text-green-400 profile-balance">0</span>
                </div>
                <div class="glass-panel p-4 rounded-2xl flex flex-col items-center">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</span>
                    <span id="profile-games-played" class="text-xl font-mono font-bold text-blue-400">0</span>
                </div>
            </div>
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 px-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-white/5 flex items-center justify-between">
                    <span class="text-sm font-bold text-white">–ó–≤—É–∫–∏</span>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="setting-sound" onchange="toggleSetting('sound')" checked class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600 transition-all duration-300"/>
                        <label class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-700 cursor-pointer"></label>
                    </div>
                </div>
                <div class="p-4 flex items-center justify-between">
                    <span class="text-sm font-bold text-white">–í–∏–±—Ä–∞—Ü–∏—è</span>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="setting-haptic" onchange="toggleSetting('haptic')" checked class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600 transition-all duration-300"/>
                        <label class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-700 cursor-pointer"></label>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= PAGE: LEADERS ================= -->
        <div id="view-leaders" class="page-view px-4 py-6">
             <div class="text-center mt-10 opacity-50">
                <div class="text-6xl mb-4">üèÜ</div>
                <h2 class="text-xl font-bold">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
                <p class="text-sm">–°–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è...</p>
             </div>
        </div>
         <div class="w-full h-20 shrink-0"></div> 

    </main>

    <!-- BOTTOM NAV (–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) -->
    <nav class="fixed bottom-4 left-4 right-4 h-16 glass-panel rounded-2xl z-40 flex justify-between items-center px-4 shadow-2xl">
        <div class="bottom-nav-item active-nav cursor-pointer" onclick="navigate('home')" id="nav-home">
            <span class="text-xl">üè†</span><span class="text-[9px] font-bold">–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="bottom-nav-item cursor-pointer" onclick="toggleWallet(true)">
            <span class="text-xl">üëõ</span><span class="text-[9px] font-bold">–ö–æ—à–µ–ª–µ–∫</span>
        </div>
        <div class="bottom-nav-item cursor-pointer" onclick="navigate('leaders')" id="nav-leaders">
            <span class="text-xl">üèÜ</span><span class="text-[9px] font-bold">–õ–∏–¥–µ—Ä—ã</span>
        </div>
        <div class="bottom-nav-item cursor-pointer" onclick="navigate('profile')" id="nav-profile">
            <span class="text-xl">üë§</span><span class="text-[9px] font-bold">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <!-- WALLET MODAL -->
    <div id="wallet-modal" class="fixed inset-0 z-[60] hidden flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
        <div id="wallet-content" class="bg-[#1e293b] w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 border-t border-white/10 shadow-2xl relative transform transition-transform duration-200 ease-out">
            <!-- Drag Handle -->
            <div id="drag-handle" class="w-full h-8 absolute top-0 left-0 flex items-center justify-center cursor-grab touch-none">
                 <div class="w-12 h-1.5 bg-slate-600 rounded-full"></div>
            </div>
            <!-- Close -->
            <button onclick="toggleWallet(false)" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-800 text-slate-400 flex items-center justify-center hover:bg-slate-700 z-10">‚úï</button>
            <!-- Body -->
            <div class="mt-6">
                <div class="text-center mb-8">
                    <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">–¢–≤–æ–π –ë–∞–ª–∞–Ω—Å</div>
                    <div class="text-4xl font-mono font-black text-yellow-400 drop-shadow-lg" id="wallet-balance-big">0</div>
                </div>
                <div class="space-y-3">
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between border border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-xl shadow-lg">üéÅ</div>
                            <div>
                                <div class="text-sm font-bold text-white">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</div>
                                <div class="text-[10px] text-slate-400">–î–æ—Å—Ç—É–ø–Ω–æ —Ä–∞–∑ –≤ 24 —á–∞—Å–∞</div>
                            </div>
                        </div>
                        <button id="btn-daily-bonus" onclick="claimDailyBonus()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold shadow-lg transition disabled:bg-slate-700 disabled:text-slate-400">–ó–ê–ë–†–ê–¢–¨</button>
                    </div>
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between border border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-xl shadow-lg">ü§ù</div>
                            <div>
                                <div class="text-sm font-bold text-white">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞</div>
                                <div class="text-[10px] text-yellow-400 font-bold">+5000</div>
                            </div>
                        </div>
                        <button onclick="inviteFriend()" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold shadow-lg transition active:scale-95">
                            –ó–û–í–ò!
                        </button>
                    </div>
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between border border-white/5 opacity-60">
                         <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-xl shadow-lg">üìù</div>
                            <div class="text-sm font-bold text-white">–ó–∞–¥–∞–Ω–∏—è</div>
                        </div>
                        <span class="text-[10px] border border-slate-600 px-2 py-1 rounded">–°–∫–æ—Ä–æ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT PROFILE MODAL -->
    <div id="edit-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-[#1e293b] w-[90%] max-w-sm rounded-3xl p-6 border border-white/10 shadow-2xl transform scale-95 transition-all duration-200 relative overflow-hidden" id="edit-modal-content">
            
            <!-- Close Button -->
            <button onclick="toggleEditModal(false)" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-800 text-slate-400 hover:text-white flex items-center justify-center z-10">‚úï</button>

            <h3 class="text-xl font-black text-white italic mb-4 text-center">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
            
            <div class="space-y-5">
                
                <!-- 1. –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ -->
                <div>
                    <label class="text-[10px] text-slate-400 font-bold uppercase tracking-wider ml-1">–¢–≤–æ–µ –∏–º—è</label>
                    <div class="relative mt-1">
                        <input type="text" id="input-edit-name" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white font-bold focus:outline-none focus:border-yellow-400 transition placeholder-slate-600 text-center" placeholder="–ò–º—è...">
                    </div>
                </div>

                <!-- 2. –í—ã–±–æ—Ä –ê–≤–∞—Ç–∞—Ä–∞ -->
                <div>
                    <label class="text-[10px] text-slate-400 font-bold uppercase tracking-wider ml-1 mb-2 block">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</label>
                    
                    <!-- –°–µ—Ç–∫–∞ —ç–º–æ–¥–∑–∏ -->
                    <div class="grid grid-cols-5 gap-2 mb-3" id="avatar-grid">
                        <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ñ–æ—Ç–æ -->
                    <button onclick="selectAvatar('tg_photo')" id="btn-restore-photo" class="w-full py-2 rounded-lg border border-slate-700 bg-slate-800/50 text-slate-400 text-xs font-bold hover:bg-slate-700 hover:text-white transition flex items-center justify-center gap-2">
                        <span>üì∑</span> –í–µ—Ä–Ω—É—Ç—å —Ñ–æ—Ç–æ Telegram
                    </button>
                </div>

                <!-- Save Button -->
                <button onclick="saveProfileChanges()" class="w-full py-3 rounded-xl bg-gradient-to-r from-yellow-400 to-orange-500 text-slate-900 font-black uppercase tracking-widest shadow-lg shadow-orange-500/20 active:scale-95 transition">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </div>
        </div>
    </div>

    <!-- REWARD POPUP (–ù–û–í–û–ï –û–ö–ù–û) -->
    <div id="reward-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center bg-black/90 backdrop-blur-md transition-all duration-300 opacity-0">
        <div class="bg-slate-900 w-[85%] max-w-sm rounded-3xl p-1 border border-yellow-500/30 shadow-[0_0_50px_rgba(234,179,8,0.2)] transform scale-90 transition-transform duration-300" id="reward-content">
            <div class="bg-[#1e293b] rounded-[20px] p-6 flex flex-col items-center text-center relative overflow-hidden">
                
                <!-- –°–∞–ª—é—Ç –Ω–∞ —Ñ–æ–Ω–µ -->
                <div class="absolute inset-0 bg-[url('https://cdn.pixabay.com/animation/2023/06/25/20/38/20-38-23-447_512.gif')] bg-cover opacity-10 pointer-events-none"></div>

                <div class="text-6xl mb-4 animate-bounce">üéÅ</div>
                
                <h3 class="text-2xl font-black text-white uppercase italic mb-1">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h3>
                <p class="text-slate-400 text-xs font-bold mb-6 px-4">–í–∞—à–∏ –¥—Ä—É–∑—å—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ!</p>

                <div class="w-full bg-slate-800/50 rounded-xl p-4 mb-6 border border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400 text-xs font-bold uppercase">–î—Ä—É–∑–µ–π</span>
                        <span class="text-white font-bold" id="reward-friends-count">0</span>
                    </div>
                    <div class="w-full h-px bg-white/10 mb-2"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-yellow-500 text-xs font-bold uppercase">–ë–æ–Ω—É—Å</span>
                        <span class="text-yellow-400 font-mono font-black text-xl" id="reward-amount">+0</span>
                    </div>
                </div>

                <button onclick="closeRewardPopup()" class="w-full py-3 rounded-xl bg-gradient-to-r from-yellow-400 to-orange-500 text-slate-900 font-black uppercase tracking-widest shadow-lg shadow-orange-500/20 active:scale-95 transition relative z-10">
                    –ó–ê–ë–†–ê–¢–¨ –ú–û–ù–ï–¢–´
                </button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const INITIAL_BALANCE = 1000;
        const DAILY_AMOUNT = 1000;

        // === –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ===
        // ‚ö†Ô∏è –ù–ï –ó–ê–ë–£–î–¨ –í–°–¢–ê–í–ò–¢–¨ –°–í–û–ò –ö–õ–Æ–ß–ò!
        const SUPABASE_URL = 'https://ugkactbowbcxkwnovkwe.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_myr7kO9VcTIIuwVwRKWIAg_8Ee_-5Ga';
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫–ª—é—á–∏ –Ω–µ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã (—á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ —Å –æ—à–∏–±–∫–æ–π)
        let sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let currentUserTgId = null;

        // === –§–£–ù–ö–¶–ò–ò –ë–ê–ó–´ –î–ê–ù–ù–´–• ===

        // 1. –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        // === –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–•–û–î–ê –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ===
        async function syncUserWithDB(user) {
            if (!sb || !user) return null; 
            currentUserTgId = user.id.toString();
            
            // –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Ñ–æ—Ç–æ –∏–∑ —Ç–µ–ª–µ–≥—Ä–∞–º–∞ (–Ω–∞ —Å–ª—É—á–∞–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
            const tgPhoto = user.photo_url || null;

            // 1. –ò—â–µ–º –∏–≥—Ä–æ–∫–∞
            let { data: player, error } = await sb
                .from('players')
                .select('*')
                .eq('tg_id', currentUserTgId)
                .single();

            if (!player) {
                // === –ù–û–í–´–ô –ò–ì–†–û–ö ===
                let startBalance = 1000;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏
                const referrerId = tg.initDataUnsafe?.start_param;
                if (referrerId && referrerId !== currentUserTgId) {
                    const { data: referrerUser } = await sb.from('players').select('balance').eq('tg_id', referrerId).single();
                    if (referrerUser) {
                        await sb.from('players').update({ balance: referrerUser.balance + 5000 }).eq('tg_id', referrerId);
                    }
                }

                // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
                const { data: newPlayer, error: insertError } = await sb
                    .from('players')
                    .insert([{ 
                        tg_id: currentUserTgId, 
                        username: user.first_name, 
                        balance: startBalance,
                        avatar_url: tgPhoto // –ü—Ä–∏ –ø–µ—Ä–≤–æ–π —Ä–µ–≥–µ —Å—Ç–∞–≤–∏–º —Ñ–æ—Ç–æ –∏–∑ –¢–ì
                    }])
                    .select()
                    .single();
                
                if (!insertError && newPlayer) {
                    localStorage.setItem('jigu_bal_xl', startBalance);
                    return newPlayer; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–≥—Ä–æ–∫–∞
                }
                
                // –§–æ–ª–±—ç–∫ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏
                return { balance: startBalance, avatar_url: tgPhoto, username: user.first_name };

            } else {
                // === –ò–ì–†–û–ö –£–ñ–ï –ï–°–¢–¨ ===
                // –ú—ã –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º avatar_url –∑–¥–µ—Å—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ —Å—Ç–µ—Ä–µ—Ç—å —ç–º–æ–¥–∑–∏!
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ—Ç–∏–º, –Ω–∞–ø—Ä–∏–º–µ—Ä, last_seen –∏–ª–∏ —á—Ç–æ-—Ç–æ —Ç–∞–∫–æ–µ.
                
                localStorage.setItem('jigu_bal_xl', player.balance);
                return player; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–≥—Ä–æ–∫–∞ –∏–∑ –±–∞–∑—ã
            }
        }

        // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        async function saveBalanceToDB(newBalance) {
            // –í—Å–µ–≥–¥–∞ –ø–∏—à–µ–º –≤ –ª–æ–∫–∞–ª–∫—É –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Ä–µ–∞–∫—Ü–∏–∏
            localStorage.setItem('jigu_bal_xl', newBalance);

            // –ï—Å–ª–∏ –µ—Å—Ç—å –±–∞–∑–∞ –∏ —é–∑–µ—Ä - —à–ª–µ–º –≤ –æ–±–ª–∞–∫–æ
            if (sb && currentUserTgId) {
                await sb
                    .from('players')
                    .update({ balance: newBalance })
                    .eq('tg_id', currentUserTgId);
            }
        }

        // 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏–¥–µ—Ä–æ–≤
        async function getLeaderboard() {
            if (!sb) return [];
            const { data, error } = await sb
                .from('players')
                // –î–û–ë–ê–í–ò–õ–ò games_played –í –ó–ê–ü–†–û–° üëá
                .select('username, balance, avatar_url, games_played') 
                .order('balance', { ascending: false })
                .limit(10);
            return data || [];
        }

        // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ª–∏–¥–µ—Ä–æ–≤
        async function showLeaders() {
            const listContainer = document.getElementById('view-leaders');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            listContainer.innerHTML = `
                <div class="flex flex-col items-center mt-20 animate-pulse opacity-70">
                    <div class="text-4xl mb-2">‚è≥</div>
                    <div class="text-yellow-400 font-bold">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ø–∞...</div>
                </div>`;
            
            const leaders = await getLeaderboard();
            
            if (leaders.length === 0) {
                listContainer.innerHTML = '<div class="text-center mt-10 opacity-50">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ</div>';
                return;
            }

            let html = '<h2 class="text-2xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-6 uppercase drop-shadow-sm">üèÜ –¢–æ–ø –ë–æ–≥–∞—á–µ–π</h2><div class="space-y-3">';
            
            leaders.forEach((player, index) => {
                let medal = index === 0 ? 'ü•á' : (index === 1 ? 'ü•à' : (index === 2 ? 'ü•â' : `#${index+1}`));
                
                let bgClass = index === 0 ? 'bg-yellow-500/20 border-yellow-500/50 shadow-[0_0_15px_rgba(234,179,8,0.2)]' : 
                            (index === 1 ? 'bg-slate-600/40 border-slate-500/50' : 
                            (index === 2 ? 'bg-orange-900/40 border-orange-700/50' : 'glass-panel border-white/5'));
                
                // === –õ–û–ì–ò–ö–ê –ê–í–ê–¢–ê–†–ê ===
                let avatarHTML;
                const raw = player.avatar_url;
                const isUrl = raw && (raw.includes('http') || raw.includes('https'));

                if (isUrl) {
                    avatarHTML = `<img src="${raw}" class="w-9 h-9 rounded-full object-cover border border-white/20 bg-slate-900">`;
                } else {
                    const emoji = raw || 'üòé';
                    avatarHTML = `<div class="w-9 h-9 rounded-full bg-slate-800 flex items-center justify-center text-xl border border-white/10 select-none shadow-inner">${emoji}</div>`;
                }

                // üî• –í–ê–ñ–ù–û: –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –ë–´–õ–ê –ü–†–û–ü–£–©–ï–ù–ê
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–Ω–≥ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤ HTML
                const rank = getPlayerRank(player.games_played); 
                
                // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É
                html += `
                    <div class="p-3 rounded-xl flex items-center justify-between border ${bgClass} transition hover:scale-[1.02]">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="text-sm font-black w-6 text-center text-slate-400 shrink-0">${medal}</div>
                            
                            ${avatarHTML}
                            
                            <div class="flex flex-col overflow-hidden">
                                <div class="font-bold text-white text-sm truncate max-w-[110px]">${player.username}</div>
                                <!-- –ë–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞ -->
                                <div class="text-[9px] leading-tight opacity-90 mt-0.5">
                                <span class="${rank.style} px-1.5 py-0.5 rounded-[4px] inline-block border-0 shadow-none font-bold text-[8px] tracking-wide">
                                        ${rank.title}
                                </span>
                                </div>
                            </div>
                        </div>
                        <div class="font-mono text-yellow-400 font-bold text-sm tracking-tight shrink-0 ml-2">
                            ${player.balance.toLocaleString('ru-RU')}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            listContainer.innerHTML = html;
        }

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        async function initApp() {
            tg.expand();

            // 1. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∏–∑ –∫—ç—à–∞ (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
            updateBalanceUI(); 
            
            let user = tg.initDataUnsafe?.user;

            // –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (–≤ –±—Ä–∞—É–∑–µ—Ä–µ)
            if (!user) {
                console.warn("‚ö†Ô∏è –ó–∞–ø—É—â–µ–Ω–æ –≤–Ω–µ Telegram! –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º.");
                user = {
                    id: 111111,
                    first_name: "Test",
                    last_name: "Player",
                    username: "test_dev",
                    photo_url: null // –ù–µ—Ç —Ñ–æ—Ç–æ
                };
            }

            if (user) {
                // 2. –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ UI (–∏–º—è)
                const displayName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                document.getElementById('username').innerText = user.first_name;
                document.getElementById('profile-name').innerText = displayName;

                // 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ë–î
                // –ñ–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –±–∞–∑—ã, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ê–≤–∞—Ç–∞—Ä –∏ –ë–∞–ª–∞–Ω—Å
                const playerData = await syncUserWithDB(user);

                if (playerData) {
                    // –ï—Å–ª–∏ –±–∞–∑–∞ –æ—Ç–≤–µ—Ç–∏–ª–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —Ç–æ—á–Ω–æ
                    localStorage.setItem('jigu_bal_xl', playerData.balance);
                    updateBalanceUI();
                    updateRankUI(playerData.games_played || 0);

                    // –ï—Å–ª–∏ –≤ –±–∞–∑–µ –µ—Å—Ç—å –∏–º—è (–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º), —Å—Ç–∞–≤–∏–º –µ–≥–æ
                    if (playerData.username) {
                        document.getElementById('username').innerText = playerData.username;
                        document.getElementById('profile-name').innerText = playerData.username;
                    }

                    // === –ì–õ–ê–í–ù–û–ï: –û–¢–†–ò–°–û–í–ö–ê –ê–í–ê–¢–ê–†–ê ===
                    // –ë–µ—Ä–µ–º –∏–∑ –±–∞–∑—ã, –µ—Å–ª–∏ –Ω–µ—Ç - —Ç–æ –∏–∑ —Ç–µ–ª–µ–≥—Ä–∞–º–∞, –µ—Å–ª–∏ –Ω–µ—Ç - —Ç–æ –∑–∞–≥–ª—É—à–∫—É
                    
                    const finalAvatar = playerData.avatar_url || user.photo_url;
                    renderAvatarGlobal(finalAvatar); // –§—É–Ω–∫—Ü–∏—è –∏–∑ profile.js
                } else {
                    // –ï—Å–ª–∏ –±–∞–∑—ã –Ω–µ—Ç (–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏), —Å—Ç–∞–≤–∏–º —Ñ–æ—Ç–æ –∏–∑ –¢–ì
                    renderAvatarGlobal(user.photo_url);
                }
                
            } else {
                // –°–æ–≤—Å–µ–º —Ñ–æ–ª–±—ç–∫ (–≤—Ä—è–¥ –ª–∏ —Å–ª—É—á–∏—Ç—Å—è)
                checkFirstTime();
                updateBalanceUI();
            }

            // –ó–∞–ø—É—Å–∫ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
            checkDailyStatus();
            setupSwipeToClose();
            initSettings();
        }

        function initSettings() {
            const soundOn = localStorage.getItem('moji_sound') !== 'false';
            const hapticOn = localStorage.getItem('moji_haptic') !== 'false';
            const soundCheck = document.getElementById('setting-sound');
            const hapticCheck = document.getElementById('setting-haptic');

            if(soundCheck) soundCheck.checked = soundOn;
            if(hapticCheck) hapticCheck.checked = hapticOn;
        }

        function toggleSetting(type) {
            if (type === 'sound') {
                const isChecked = document.getElementById('setting-sound').checked;
                localStorage.setItem('moji_sound', isChecked);
            }
            if (type === 'haptic') {
                const isChecked = document.getElementById('setting-haptic').checked;
                localStorage.setItem('moji_haptic', isChecked);
                if (isChecked && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            }
        }

        // –§–æ–ª–±—ç–∫ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function checkFirstTime() {
            if (localStorage.getItem('jigu_bal_xl') === null) {
                localStorage.setItem('jigu_bal_xl', INITIAL_BALANCE);
            }
        }

        function updateBalanceUI() {
            const bal = parseInt(localStorage.getItem('jigu_bal_xl') || 0);
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 1 000 000 –≤–º–µ—Å—Ç–æ 1000000
            const formattedBal = bal.toLocaleString('ru-RU');

            document.getElementById('header-balance').innerText = formattedBal;
            document.getElementById('wallet-balance-big').innerText = formattedBal;
            document.querySelector('.profile-balance').innerText = formattedBal;
        }

        function getTodayString() { return new Date().toDateString(); }

        function checkDailyStatus() {
            const lastDate = localStorage.getItem('last_daily_date');
            const btn = document.getElementById('btn-daily-bonus');
            if (lastDate === getTodayString()) {
                btn.disabled = true;
                btn.innerText = "–ó–ê–í–¢–†–ê";
            } else {
                btn.disabled = false;
                btn.innerText = `+${DAILY_AMOUNT}`;
            }
        }

        // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –±–∞–∑—É
        function claimDailyBonus() {
            if(document.getElementById('btn-daily-bonus').disabled) return;
            
            let current = parseInt(localStorage.getItem('jigu_bal_xl') || 0);
            let newBalance = current + DAILY_AMOUNT;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ª–æ–∫–∞–ª—å–Ω–æ, –∏ –≤ –æ–±–ª–∞–∫–æ
            saveBalanceToDB(newBalance);
            localStorage.setItem('last_daily_date', getTodayString());
            
            updateBalanceUI();
            checkDailyStatus();
            spawnCoins();
            
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            
            const btn = document.getElementById('btn-daily-bonus');
            btn.innerText = "–£–°–ü–ï–®–ù–û!";
            //setTimeout(() => toggleWallet(false), 700);
        }

        // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ showLeaders()
        function navigate(viewId) {
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            
            document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-item').forEach(el => el.classList.remove('active-nav'));
            
            document.getElementById(`view-${viewId}`).classList.add('active');
            const navBtn = document.getElementById(`nav-${viewId}`);
            if(navBtn) navBtn.classList.add('active-nav');

            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –ª–∏–¥–µ—Ä–æ–≤ - –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (viewId === 'leaders') {
                showLeaders();
            }

            refreshPlayerData();
        }

        async function refreshPlayerData() {
            if (!sb || !currentUserTgId) return;

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã
            const { data: player, error } = await sb
                .from('players')
                .select('*')
                .eq('tg_id', currentUserTgId)
                .single();

            if (player && !error) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å, –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
                localStorage.setItem('jigu_bal_xl', player.balance);
                updateBalanceUI();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
                if (typeof updateGamesPlayedUI === 'function') {
                    updateGamesPlayedUI(player.games_played || 0);
                }

                updateRankUI(player.games_played || 0);

                // üî• –ü–†–û–í–ï–†–Ø–ï–ú –ù–ê–ì–†–ê–î–´
                await checkReferralRewards(player);
            }
        }

        function openGame(url) {
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            setTimeout(() => window.location.href = url, 100);
        }

        function toggleWallet(show) {
            const modal = document.getElementById('wallet-modal');
            const content = document.getElementById('wallet-content');
            if(show) {
                modal.classList.remove('hidden');
                content.style.transform = 'translateY(100%)'; 
                setTimeout(() => { content.style.transform = 'translateY(0)'; }, 10);
                checkDailyStatus();
            } else {
                content.style.transform = 'translateY(100%)';
                setTimeout(() => { modal.classList.add('hidden'); }, 200);
            }
        }

        function setupSwipeToClose() {
            const content = document.getElementById('wallet-content');
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            content.addEventListener('touchstart', (e) => {
                if (content.scrollTop > 0) return;
                startY = e.touches[0].clientY;
                isDragging = true;
                content.style.transition = 'none';
            }, {passive: true});

            content.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                let diff = currentY - startY;
                if (diff > 0) {
                    e.preventDefault();
                    content.style.transform = `translateY(${diff}px)`;
                }
            }, {passive: false});

            content.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                content.style.transition = 'transform 0.2s ease-out';
                let diff = currentY - startY;
                if (diff > 100 && currentY > startY) toggleWallet(false);
                else content.style.transform = 'translateY(0)';
            });
            
            document.getElementById('wallet-modal').addEventListener('click', (e) => {
                if(e.target.id === 'wallet-modal') toggleWallet(false);
            });
        }

        function inviteFriend() {
            // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            const userId = currentUserTgId || tg.initDataUnsafe?.user?.id;
            if (!userId) return tg.showAlert("–û—à–∏–±–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏!");

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É. startapp=ID –ø–µ—Ä–µ–¥–∞—Å—Ç —Ç–≤–æ–π ID –¥—Ä—É–≥—É
            // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï –ù–ò–ñ–ï üëá
            const botUserName = "mojislots_bot"; // –ò–º—è —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞ (–±–µ–∑ @)
            const appName = "mojislots";            // Short name –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∫–æ—Ç–æ—Ä–æ–µ —Ç—ã –≤–≤–æ–¥–∏–ª –≤ BotFather)
            
            const inviteLink = `https://t.me/${botUserName}/${appName}?startapp=${userId}`;
            const text = `–°–º–æ—Ç—Ä–∏ –∫–∞–∫—É—é –Ω–∞—à—ë–ª –∏–≥—Ä—É! –ò–≥—Ä–∞–µ–º –≤–º–µ—Å—Ç–µ?`;

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π —à–µ—Ä–∏–Ω–≥ —Ç–µ–ª–µ–≥—Ä–∞–º–∞
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent(text)}`;
            tg.openTelegramLink(shareUrl);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ "–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ"
        function updateGamesPlayedUI(count) {
            const el = document.getElementById('profile-games-played');
            if (el) el.innerText = count;
        }

        function showRewardPopup(friendsCount, bonusAmount) {
            const modal = document.getElementById('reward-modal');
            const content = document.getElementById('reward-content');
            const friendsEl = document.getElementById('reward-friends-count');
            const amountEl = document.getElementById('reward-amount');

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            friendsEl.innerText = friendsCount;
            amountEl.innerText = `+${bonusAmount.toLocaleString()}`;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ
            modal.classList.remove('hidden');
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-90');
                content.classList.add('scale-100');
            }, 10);

            // –í–∏–±—Ä–∞—Ü–∏—è –∏ –∑–≤—É–∫
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            spawnCoins(); // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–µ—Ç–∫–∏ —Å—Ä–∞–∑—É –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
        }

        function closeRewardPopup() {
            const modal = document.getElementById('reward-modal');
            const content = document.getElementById('reward-content');

            // –ê–Ω–∏–º–∞—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-90');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –¥—Ä—É–∑–µ–π
        async function checkReferralRewards(playerData) {
            const pending = parseInt(playerData.pending_referrals || 0);
            
            // –ò–ó–ú–ï–ù–ï–ù–û: –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –¥—Ä—É–≥ (–±—ã–ª–æ >= 2)
            if (pending > 0) {
                const bonusPerFriend = 5000;
                const totalBonus = pending * bonusPerFriend;
                
                console.log(`–ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å –∑–∞ –¥—Ä—É–∑–µ–π: ${totalBonus}`);

                const newBalance = (playerData.balance || 0) + totalBonus;
                
                // 1. –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É (–æ–±–Ω—É–ª—è–µ–º pending_referrals)
                const { error } = await sb
                    .from('players')
                    .update({ 
                        balance: newBalance,
                        pending_referrals: 0 
                    })
                    .eq('tg_id', currentUserTgId);

                if (!error) {
                    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                    saveBalanceToDB(newBalance);
                    updateBalanceUI();

                    // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ö–†–ê–°–ò–í–û–ï UI —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ
                    showRewardPopup(pending, totalBonus);
                }
            }
        }

        // === –§–£–ù–ö–¶–ò–Ø –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –†–ê–ù–ì–ê ===
        function getPlayerRank(gamesPlayed) {
            const count = parseInt(gamesPlayed) || 0;

            // 50k+
            if (count >= 50000) return { 
                title: 'üëë –ò–º–ø–µ—Ä–∞—Ç–æ—Ä', // –°–æ–∫—Ä–∞—Ç–∏–ª –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã –≤ –º–æ–±–∏–ª–∫–µ
                style: 'bg-gradient-to-r from-yellow-600 via-orange-500 to-red-600 text-white border-none shadow-[0_0_10px_rgba(234,179,8,0.6)] animate-pulse' 
            };
            // 20k+
            if (count >= 20000) return { 
                title: 'üßû‚Äç‚ôÇÔ∏è –î–∂–∏–Ω–Ω', 
                style: 'bg-gradient-to-r from-purple-600 to-blue-600 text-white border-none shadow-[0_0_10px_rgba(147,51,234,0.5)]' 
            };
            // 10k+
            if (count >= 10000) return { 
                title: 'ü¶à –ê–∫—É–ª–∞', 
                style: 'bg-red-950 text-red-100 border-red-500 shadow-sm' 
            };
            // 5k+
            if (count >= 5000) return { 
                title: 'üé© –•–∞–π—Ä–æ–ª–ª–µ—Ä', 
                style: 'bg-emerald-900 text-emerald-100 border-emerald-500/50' 
            };
            // 3k+
            if (count >= 3000) return { 
                title: 'ü•¥ –õ—É–¥–æ–º–∞–Ω', 
                style: 'bg-orange-900 text-orange-100 border-orange-500/50' 
            };
            // 1k+
            if (count >= 1000) return { 
                title: 'üÉè –ü—Ä–æ—Ñ–∏', 
                style: 'bg-blue-900 text-blue-100 border-blue-500/50' 
            };
            // 500+
            if (count >= 500) return { 
                title: 'üçÄ –§–∞—Ä—Ç–æ–≤—ã–π', 
                style: 'bg-cyan-900 text-cyan-100 border-cyan-500/50' 
            };
            // 150+
            if (count >= 150) return { 
                title: 'üèÉ‚Äç‚ôÇÔ∏è –ê–∫—Ç–∏–≤–Ω—ã–π', 
                style: 'bg-teal-900 text-teal-100 border-teal-500/30' 
            };
            // 50+
            if (count >= 50) return { 
                title: 'üé≤ –ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å', 
                style: 'bg-slate-800 text-slate-200 border-slate-600/50' 
            };
            
            // < 50
            return { 
                title: 'üê£ –ù–æ–≤–∏—á–æ–∫', 
                style: 'bg-slate-800 text-slate-500 border-slate-700/30' 
            };
        }

        function updateRankUI(gamesPlayed) {
            const rank = getPlayerRank(gamesPlayed);
            
            // 1. –û–±–Ω–æ–≤–ª—è–µ–º –®–∞–ø–∫—É (–ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç)
            const headerEl = document.getElementById('header-rank');
            if(headerEl) {
                headerEl.innerText = rank.title;
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å:
                // headerEl.className = "text-[10px] font-bold uppercase tracking-wider " + rank.style.replace('bg-', 'text-').replace('text-white', '');
            }

            // 2. –û–±–Ω–æ–≤–ª—è–µ–º –ë–µ–π–¥–∂ –≤ –ø—Ä–æ—Ñ–∏–ª–µ (–ø–æ–ª–Ω—ã–π —Å—Ç–∏–ª—å)
            const profileBadge = document.getElementById('profile-rank-badge');
            if(profileBadge) {
                profileBadge.innerText = rank.title;
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ + –Ω–æ–≤—ã–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
                profileBadge.className = `px-3 py-1 mt-2 rounded-full text-[10px] font-bold border transition-all duration-300 inline-block shadow-lg ${rank.style}`;
            }
        }

        // === –ê–ù–ò–ú–ê–¶–ò–Ø –ú–û–ù–ï–¢–û–ö (–í–ò–ó–£–ê–õ–¨–ù–´–ô –≠–§–§–ï–ö–¢) ===
        // –í—ã–∑—ã–≤–∞–π spawnCoins() –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç –±–æ–Ω—É—Å!
        
        function spawnCoins() {
            const count = 15; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç
            const container = document.body;

            for (let i = 0; i < count; i++) {
                const coin = document.createElement('div');
                coin.innerText = 'üí∞';
                coin.style.position = 'fixed';
                coin.style.left = '50%';
                coin.style.top = '50%';
                coin.style.fontSize = '24px';
                coin.style.zIndex = '100';
                coin.style.pointerEvents = 'none';
                coin.style.transition = 'all 0.8s ease-in';
                
                // –°–ª—É—á–∞–π–Ω—ã–π —Ä–∞–∑–ª–µ—Ç
                const x = (Math.random() - 0.5) * window.innerWidth * 0.8;
                const y = (Math.random() - 0.5) * window.innerHeight * 0.5;
                
                coin.style.transform = `translate(${x}px, ${y}px) scale(1.5)`;
                
                container.appendChild(coin);

                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª–µ—Ç–∞ –∫ –∫–æ—à–µ–ª—å–∫—É (–≤ –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª)
                setTimeout(() => {
                    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–æ—à–µ–ª—å–∫–∞ –≤ —Ö–µ–¥–µ—Ä–µ
                    const walletRect = document.getElementById('header-balance').getBoundingClientRect();
                    const targetX = walletRect.left - (window.innerWidth / 2) + 10;
                    const targetY = walletRect.top - (window.innerHeight / 2) + 10;

                    coin.style.transform = `translate(${targetX}px, ${targetY}px) scale(0.5)`;
                    coin.style.opacity = '0';
                }, 100);

                // –£–¥–∞–ª–µ–Ω–∏–µ
                setTimeout(() => {
                    coin.remove();
                }, 900);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å (–≤–¥—Ä—É–≥ –≤ –∏–≥—Ä–µ –∏–∑–º–µ–Ω–∏–ª—Å—è)
            window.addEventListener('focus', () => {
                updateBalanceUI();
                checkDailyStatus();
            });
        });
    </script>
</body>
</html>
